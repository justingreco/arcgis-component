import { y, r, e, d, n, s, t, J as g, H as l$2, by as A, h as e$2 } from './cast-3d5be210.js';
import { g as g$1 } from './Graphic-93f45ded.js';
import { n as n$2 } from './compilerUtils-d149ad5f.js';
import { d as d$1 } from './HandleOwner-fe336959.js';
import { a, l as l$3, f, h } from './reactiveUtils-bd6fe823.js';
import { m as m$1 } from './diffUtils-6436a697.js';
import { g as g$2, M as M$2 } from './Point-edff2a11.js';
import { C, E as E$1, e as e$1, a as a$1, s as s$2, k, r as r$1 } from './SceneView-ed3703c9.js';
import { b } from './Query-1f6c7e43.js';
import { b as b$1, j as je } from './Graphics3DScaleVisibility-67960f77.js';
import { d as d$2, l as l$1, s as s$1 } from './Graphics3DObjectStates-368614cc.js';
import { u } from './Handles-54afc0a7.js';
import { E } from './Collection-a38e0489.js';
import { y as y$1 } from './labelingInfo-6e0c44d1.js';
import { o } from './floorFilterUtils-904cfc06.js';
import { b as i } from './geometry-2f332a26.js';
import { M as M$1 } from './Extent-f27111e1.js';
import { Y } from './QueryEngine-115f26ee.js';
import x from './FeatureSet-1b85367a.js';
import { L } from './Scheduler-ed7a36dc.js';
import { n as n$1 } from './attributeUtils-af7a9a43.js';
import { o as o$1, u as u$1 } from './OrderIndependentTransparency-b8c8f539.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const c=Y;let l=class extends y{constructor(e){super(e),this._dataQueryEngineInstance=null;}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return "polygon";default:return}}get defaultQueryJSON(){return new b({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}destroy(){this.clear();}clear(){return !!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,r){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,r))}async executeQueryForCount(e,r){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return {count:t,extent:M$1.fromJSON(s)}}async executeQueryForIds(e,r){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQueryForLatestObservations(e,r){const t=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),r),s=x.fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}async executeQuery(e,r){const t=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),r),s=x.fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}_ensureQueryJSON(e,r$1){let s=this.defaultQueryJSON;return r(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),s=e.toJSON()),r(r$1)&&(s={...s,sceneFilter:{...r$1,geometry:r$1.geometry.toJSON()}}),s}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,r=this.layer.objectIdField,t=i.toJSON(this.queryGeometryType),s=this.layer.fields.map((e=>e.toJSON())),a=this.layerView.view.resourceController.scheduler,n=this.priority,o=this.spatialReference.toJSON(),i$1=this.layerView.processor.featureStore,{hasZ:u,hasM:l}=this.layerView;return this._dataQueryEngineInstance=new c({hasZ:u,hasM:l,geometryType:t,fields:s,timeInfo:e,spatialReference:o,objectIdField:r,featureStore:i$1,scheduler:a,priority:n}),this._dataQueryEngineInstance}};e([d({constructOnly:!0})],l.prototype,"layerView",void 0),e([d({constructOnly:!0})],l.prototype,"priority",void 0),e([d({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],l.prototype,"spatialReference",void 0),e([d({readOnly:!0,aliasOf:"layerView.layer"})],l.prototype,"layer",void 0),e([d({readOnly:!0})],l.prototype,"queryGeometryType",null),e([d({readOnly:!0})],l.prototype,"defaultQueryJSON",null),l=e([n("esri.views.3d.layers.graphics.QueryEngine")],l);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const m=s.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let F$1=class extends y{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new u;}get updating(){return this._dirty||this._querying||r(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new l({layerView:this._layerView,priority:L.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(L.FILTER_VISIBILITY,this)),this._handles.add(a((()=>t.owner?.loadedGraphics),"after-changes",(e=>this._graphicsChanged(e)),{onListenerAdd:()=>this.dirty=!0})),this.filterChanged();}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null;}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(C.FILTER))),this._queryResult=null,this._querying=!1),this.dirty=!1;}_graphicsChanged(e){this._queryEngine&&0==(e.type&E.ADD)||(this.dirty=!0);}updateVisibility(e){this.active&&(e.hasVisibilityFlag(C.FILTER,E$1.GRAPHIC)||e.setVisibilityFlag(C.FILTER,!1,E$1.GRAPHIC),this.dirty=!0);}filterChanged(){const e=this._recomputeFilter();e!==this._featureFilter&&(this._featureFilter=e,this.dirty=!0);const t="layerFilter"in this._layerView?this._layerView.layerFilter:null;t!==this._sceneFilter&&(this._sceneFilter=t,this.dirty=!0);}get active(){return (this._featureFilter||this._sceneFilter)&&this._core.graphics3DGraphics.size>0}_recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t$1="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=o(this._layerView);if(t(t$1)&&t(i))return e;const r$1=r(e)?e.clone():new y$1;if(r(t$1)&&(r$1.timeExtent=r(r$1.timeExtent)?r$1.timeExtent.intersection(t$1):t$1),r(i)){const e=null==r$1.where||""===r$1.where;r$1.where=e?i:`(${r$1.where}) AND (${i})`;}return r$1}get running(){return this._dirty&&!this._querying||r(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._featureFilter,this._sceneFilter).then((e=>{this._queryResult=e,this._querying=!1;})).catch((e=>{if(!g(e)){m.warn("FeatureFilter query failed: "+e,{error:e});const t=new Set;this._core.graphics3DGraphics.forEach((e=>t.add(this._getFeatureId(e.graphic)))),this._queryResult=t,this._querying=!1;}})),e.madeProgress());const t=this._queryResult;r(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((i=>{if(e.done)return !1;const r=t.has(this._getFeatureId(i.graphic));return !!i.setVisibilityFlag(C.FILTER,r,E$1.GRAPHIC)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null));}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e;}};e([d({readOnly:!0})],F$1.prototype,"updating",null),e([d({readOnly:!0})],F$1.prototype,"running",null),e([d()],F$1.prototype,"_dirty",void 0),e([d()],F$1.prototype,"_querying",void 0),e([d()],F$1.prototype,"_queryResult",void 0),F$1=e([n("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],F$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let I=class extends d$1{constructor(e){super(e),this.type="graphics-3d",this.elevationFeatureExpressionEnabled=!1,this.dataExtent=null,this.drapeSourceType=e$1.Features,this.preferredUpdatePolicy=o$1.ASYNC,this.suspendResumeExtent=null;}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new d$2:null,i=e.scaleVisibilityEnabled?new b$1:null,s=(e.filterVisibilityEnabled||e.timeExtentEnabled)&&"multipatch"!==e.owner.layer.geometryType?new F$1:null,r=e.elevationAlignmentEnabled?new l$1:null,{owner:n,updateClippingExtent:a,dataExtent:o,elevationFeatureExpressionEnabled:l,preferredUpdatePolicy:p}=e;return {owner:n,updateClippingExtent:a,dataExtent:o,frustumVisibility:t,scaleVisibility:i,filterVisibility:s,elevationAlignment:r,elevationFeatureExpressionEnabled:l,preferredUpdatePolicy:p}}initialize(){const e=new je({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler()));const t=this.filterVisibility;r(t)&&(this.updatingHandles.add((()=>"filter"in this.owner&&this.owner.filter),(()=>t.filterChanged())),this.updatingHandles.add((()=>"timeExtent"in this.owner&&this.owner.timeExtent),(()=>t.filterChanged())),this.updatingHandles.add((()=>"layerFilter"in this.owner&&this.owner.layerFilter),(()=>t.filterChanged()))),this.elevationAlignment&&this.updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{m$1(e,t)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange());})),this.updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this.updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{m$1(e,t)&&this.graphicsCore.updateLabelingInfo();})),this.updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e));}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",l$2(this.frustumVisibility)),this._set("scaleVisibility",l$2(this.scaleVisibility)),this._set("filterVisibility",l$2(this.filterVisibility)),this._set("elevationAlignment",l$2(this.elevationAlignment)),this._set("objectStates",l$2(this.objectStates)),this._set("graphicsCore",l$2(this.graphicsCore)),this._set("owner",null);}get layer(){return this.owner.layer}get suspendResumeExtentMode(){return "suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility?.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return t(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibility?.suspended&&(e.outsideScaleRange=!0),r(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return !!(this.graphicsCore?.updating||r(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles?.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return "filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return "featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.resourceController.memoryController.memoryFactor,t=this.graphicsCore?.displayFeatureLimit;if(1===e)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e),s=Math.ceil(t.maximumTotalNumberOfFeatures*e),r=Math.ceil(t.minimumTotalNumberOfFeatures*e);return {...t,maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:r}}get usedMemory(){return this.graphicsCore?.usedMemory??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return {core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:t(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}async setup(){r(this.frustumVisibility)&&this.frustumVisibility.setup(this);const e=this.owner,t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t),r(this.filterVisibility)&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const t=e.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,t);}this._set("objectStates",new s$1(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await A(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this.updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await A(this.graphicsCore.updateLabelingInfo());}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(u$1.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,i){if(e instanceof b){const{set:t,handle:s}=this.objectStates.acquireSet(u$1.Highlight,i);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(t,e))),s}if("number"==typeof e||"string"==typeof e)return this.highlight([e],i);if(e instanceof g$1)return this.highlight([e],i);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof g$1){const t=e;if(null==n$1(this.layer.fieldsIndex,t[0].attributes,i)){const e=t.map((e=>e.uid)),{set:i,handle:s}=this.objectStates.acquireSet(u$1.Highlight,null);return this.objectStates.setUids(i,e),s}e=t.map((e=>n$1(this.layer.fieldsIndex,e.attributes,i)));}if("number"==typeof e[0]||"string"==typeof e[0]){const t=e,{set:s,handle:r}=this.objectStates.acquireSet(u$1.Highlight,i);return this.objectStates.setObjectIds(s,t),r}}return P}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e);}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e);}getRenderingInfo(e,t,i){const s=a$1(e,{renderer:t,arcade:i});if(r(s)&&s.color){const e=s.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255;}return s}getRenderingInfoAsync(e,t,i,s){return s$2(e,{renderer:t,arcade:i,...s})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t);}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics());}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(l$3((()=>this.suspendResumeExtentMode),(()=>{switch(this.handles.remove(M),this.suspendResumeExtentMode){case"computed":this.handles.add([l$3((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),h),l$3((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],M);break;case"data":this.handles.add([f((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),h),l$3((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(e$2(this.dataExtent))))],M);break;default:n$2(this.suspendResumeExtentMode);}}),h));}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null);}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!g$2(e,i))return;e=M$2(e,i);}return k(e,t,r$1,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){r(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e);}};e([d()],I.prototype,"type",void 0),e([d({constructOnly:!0})],I.prototype,"owner",void 0),e([d()],I.prototype,"layer",null),e([d({constructOnly:!0})],I.prototype,"updateClippingExtent",void 0),e([d({constructOnly:!0})],I.prototype,"elevationFeatureExpressionEnabled",void 0),e([d({constructOnly:!0})],I.prototype,"graphicsCore",void 0),e([d({constructOnly:!0})],I.prototype,"scaleVisibility",void 0),e([d({constructOnly:!0})],I.prototype,"filterVisibility",void 0),e([d({constructOnly:!0})],I.prototype,"elevationAlignment",void 0),e([d({constructOnly:!0})],I.prototype,"frustumVisibility",void 0),e([d({readOnly:!0})],I.prototype,"deconfliction",void 0),e([d({readOnly:!0})],I.prototype,"labeling",void 0),e([d({readOnly:!0})],I.prototype,"objectStates",void 0),e([d()],I.prototype,"suspendResumeExtentMode",null),e([d()],I.prototype,"dataExtent",void 0),e([d()],I.prototype,"scaleVisibilitySuspended",null),e([d()],I.prototype,"suspended",null),e([d()],I.prototype,"legendEnabled",null),e([d()],I.prototype,"suspendInfo",null),e([d()],I.prototype,"updating",null),e([d()],I.prototype,"updatingRemaining",null),e([d()],I.prototype,"featureStore",null),e([d()],I.prototype,"view",null),e([d()],I.prototype,"loadedGraphics",null),e([d()],I.prototype,"fullOpacity",null),e([d()],I.prototype,"filter",null),e([d()],I.prototype,"slicePlaneEnabled",null),e([d()],I.prototype,"drapeSourceType",void 0),e([d()],I.prototype,"updatePolicy",null),e([d()],I.prototype,"preferredUpdatePolicy",void 0),e([d()],I.prototype,"displayFeatureLimit",null),I=e([n("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],I);const F=I,M="suspendResumeExtentMode",P={remove(){},pause(){},resume(){}};

export { F, l };
