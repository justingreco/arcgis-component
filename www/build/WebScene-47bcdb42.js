import { a as s$3, e as e$2, d, n as n$3, m as m$1, S, s as s$4, b, E, r as r$2, _ as d$1, J as g, l as a$3, I as s$5, C as x$1 } from './cast-3d5be210.js';
import { c as s$6, j as j$2, S as St } from './request-ac4d8bfb.js';
import { A as A$1, m as m$2, d as d$2, L as L$1 } from './Map-3fa127ca.js';
import { u as u$1 } from './Viewpoint-e3d4029a.js';
import { j } from './Collection-a38e0489.js';
import { u as u$3 } from './Handles-54afc0a7.js';
import { m as m$3, B as B$1 } from './Portal-5df9f5a7.js';
import { n as n$8 } from './loadAll-0acccebb.js';
import { O as O$1, S as S$1 } from './MultiOriginJSONSupport-281c1c62.js';
import { m as m$4 } from './Promise-d2759b2e.js';
import { k, A as A$2, r as r$6, o as o$1 } from './Point-edff2a11.js';
import { i as i$8 } from './originUtils-184f7769.js';
import { l as l$1, d as d$3 } from './JSONSupport-dce2c67b.js';
import { M as M$1 } from './Extent-f27111e1.js';
import { v } from './HeightModelInfo-12951268.js';
import { A as An } from './projection-fbd5d346.js';
import { r as r$5 } from './heightModelInfoUtils-4737da37.js';
import { d as d$4 } from './geometry-2f332a26.js';
import b$2 from './PortalItem-fa114dd2.js';
import { i as i$5, p as p$6, a as i$9, l as l$4 } from './SlideThumbnail-551bb50e.js';
import { l as l$3 } from './ViewingMode-4a1cffad.js';
import { y, p as p$5, n as n$4, i as i$6, a as i$7, b as a$1, c as pe, r as r$4 } from './viewpointUtils-4c294048.js';
import { a as a$4 } from './saveUtils-afc71761.js';
import { n as n$6, t as t$1 } from './collectionUtils-302901c0.js';
import { x } from './Basemap-bccaf827.js';
import { a as a$2 } from './asyncUtils-96c00c9e.js';
import { l as l$2 } from './reactiveUtils-bd6fe823.js';
import { n as n$7, p as p$7 } from './mathUtils-559a53d9.js';
import { b as b$1 } from './Layer-569a1fc8.js';
import { u as u$2 } from './OperationalLayer-e04486e0.js';
import { j as j$1 } from './frustum-95850b85.js';
import { L } from './Scheduler-ed7a36dc.js';
import { r as r$1, n as n$5 } from './opacityUtils-dcd94f00.js';
import { r as r$3 } from './Version-44ff489f.js';
import './Color-25ce730a.js';
import './colorUtils-5009883d.js';
import './compilerUtils-d149ad5f.js';
import './enumeration-6695a859.js';
import './CollectionFlattener-9ce72729.js';
import './HandleOwner-fe336959.js';
import './TablesMixin-6752cfb1.js';
import './Clonable-533c7a05.js';
import './Cyclical-922b1741.js';
import './multiOriginJSONSupportUtils-917e4f3f.js';
import './unitUtils-a0a11e54.js';
import './mat4-d5df0e58.js';
import './Polyline-dcdb3782.js';
import './assets-99f5c3ee.js';
import './aaBoundingRect-5e1a4e52.js';
import './zscale-0befeff4.js';
import './arcgisLayerUrl-a268a370.js';
import './persistableUrlUtils-5dcd6081.js';
import './fieldType-eb0b42e4.js';
import './symbols-ab3e849a.js';
import './CIMSymbol-15bdb580.js';
import './fieldUtils-240a3b99.js';
import './Symbol-573a64f6.js';
import './screenUtils-31d073db.js';
import './aaBoundingBox-b312516d.js';
import './Graphic-93f45ded.js';
import './PopupTemplate-b459951f.js';
import './number-c5a37d3e.js';
import './ActionToggle-a5849e6f.js';
import './Identifiable-d9658370.js';
import './mat3-eb8de168.js';
import './quatf64-06b7eadd.js';
import './mat4f64-ef2c1a38.js';
import './vec4f64-011248e0.js';
import './sphere-4710475c.js';
import './vectorStacks-3fa8ee55.js';
import './byteSizeEstimations-5d50d6ff.js';
import './vec2f64-2956001b.js';
import './lineSegment-99193ade.js';
import './utils-eafc976f.js';
import './quat-43e08490.js';
import './vec3f32-03e33744.js';
import './Util-73f4ac53.js';
import './doublePrecisionUtils-5c7a1f3b.js';
import './scaleUtils-c3d4b164.js';
import './uuid-ac104993.js';
import './resourceUtils-cc76b8e8.js';
import './messages-5e9a4a9e.js';
import './writeUtils-ab23132f.js';
import './layerUtils-160a1a44.js';
import './commonProperties-fca3036e.js';
import './TimeExtent-66b53603.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const r="webscene:failed-to-copy-embedded-resources",o="webscene:schema-validation";function n$2(){return new s$3(r,"Copying of embedded resources is currently not supported")}function t(e){return e&&e.name===r}function s$2(r){return new s$3(o,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:r})}function i$4(e){return e&&e.name===o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var i$3;let p$4=i$3=class extends l$1{constructor(r){super(r),this.viewing=null;}clone(){return new i$3({viewing:this.viewing?this.viewing.clone():null})}};e$2([d({type:i$5,json:{write:!0}})],p$4.prototype,"viewing",void 0),p$4=i$3=e$2([n$3("esri.webscene.ApplicationProperties")],p$4);const c$5=p$4;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var p$3;let c$4=p$3=class extends l$1{constructor(e){super(e),this.environment=new y,this.spatialReference=null,this.viewpoint=null;}set viewingMode(e){this._set("viewingMode",e);}clone(){return new p$3({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};e$2([d({type:y,json:{write:{isRequired:!0}}})],c$4.prototype,"environment",void 0),e$2([d({type:k})],c$4.prototype,"spatialReference",void 0),e$2([d({type:["local","global"]})],c$4.prototype,"viewingMode",null),e$2([d({type:u$1,json:{write:{isRequired:!0}}})],c$4.prototype,"viewpoint",void 0),c$4=p$3=e$2([n$3("esri.webscene.InitialViewProperties")],c$4);const l=c$4;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var e$1;let p$2=e$1=class extends l$1{constructor(){super(...arguments),this.text="";}clone(){return new e$1({text:this.text})}};e$2([d({type:String,json:{write:!0}})],p$2.prototype,"text",void 0),p$2=e$1=e$2([n$3("esri.webscene.support.Description")],p$2);const c$3=p$2;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var c$2;let h=c$2=class extends l$1{constructor(){super(...arguments),this.lighting=new p$5,this.weather=new n$4;}clone(){return new c$2({lighting:m$1(this.lighting),weather:m$1(this.weather)})}};e$2([d({types:i$6,json:{write:!0}})],h.prototype,"lighting",void 0),e$2([d({types:i$7,json:{write:!0}})],h.prototype,"weather",void 0),h=c$2=e$2([n$3("esri.webscene.Environment")],h);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var i$2;let n$1=i$2=class extends l$1{constructor(){super(...arguments),this.opacity=null;}clone(){return new i$2({opacity:this.opacity})}cloneAndApplyTo(r){return null==this.opacity||((r=null!=r?r.clone():new A$1).opacity=this.opacity),r}static fromGround(r){return new i$2({opacity:r.opacity})}};e$2([d({type:Number,json:{type:S,read:{reader:r$1,source:"transparency"},write:{writer:(r,o)=>{o.transparency=n$5(r);},target:"transparency"}}})],n$1.prototype,"opacity",void 0),n$1=i$2=e$2([n$3("esri.webscene.support.SlideGround")],n$1);const u=n$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var i$1;let c$1=i$1=class extends l$1{constructor(r){super(r),this.id="",this.sublayerIds=null;}clone(){return new i$1({id:this.id,sublayerIds:m$1(this.sublayerIds)})}};e$2([d({type:String,json:{write:!0}})],c$1.prototype,"id",void 0),e$2([d({type:[S],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],c$1.prototype,"sublayerIds",void 0),c$1=i$1=e$2([n$3("esri.webscene.support.SlideVisibleLayer")],c$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var s$1;let p$1=s$1=class extends l$1{constructor(){super(...arguments),this.text="";}clone(){return new s$1({text:this.text})}};e$2([d({type:String,json:{write:{isRequired:!0}}})],p$1.prototype,"text",void 0),p$1=s$1=e$2([n$3("esri.webscene.support.Title")],p$1);const c=p$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let A=0;const O=j.ofType(c$1),q=s$4.getLogger("esri.webscene.Slide");let M=class extends l$1{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+A++,this.title=new c,this.description=new c$3,this.thumbnail=new p$6,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new h,this.visibleLayers=new O;}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null;}castTitle(e){return "string"==typeof e?new c({text:e}):b(c,e)}castDescription(e){return "string"==typeof e?new c$3({text:e}):b(c$3,e)}castThumbnail(e){return "string"==typeof e?new p$6({url:e}):b(p$6,e)}castBasemap(e){return m$2(e)}set visibleLayers(e){this._set("visibleLayers",n$6(e,this._get("visibleLayers"),O));}castVisibleLayers(e){return e&&"function"==typeof e.map?e.map((e=>{if("string"==typeof e)return {id:e};if(e instanceof b$1){const t=F(e);return {id:e.id,sublayerIds:t}}return e.id?{id:e.id,sublayerIds:e.sublayerIds}:(q.warn('Invalid visible layer, expected { id }, Layer or "id"'),e)})):null}clone(){return new(0,this.constructor)({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(e){const t=[];return E(this._getLayers(e.map).map((i=>e.whenLayerView(i).then((e=>{if(e.visible){const n=F(i);t.push(new c$1({id:e.layer.id,sublayerIds:n}));}})))).toArray()).then((()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(t);}))}updateFrom(e,t){return t={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...t&&t.screenshot}},e.when((()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting="virtual"===e.environment.lighting.type?a$1.prototype.clone.apply(e.environment.lighting):p$5.prototype.clone.apply(e.environment.lighting),this.environment.weather=e.environment.weather.clone(),this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?u.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e)))).then((()=>e.takeScreenshot(t.screenshot))).then((e=>(this.thumbnail=new p$6({url:e.dataUrl}),this)))}async applyTo(e,t){r$2(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=d$1(t,(()=>i.abort())),o=e.resourceController.scheduler.registerTask(L.SLIDE);let s=!1;t={animate:!0,...t,signal:this._applyToController.signal};const a=async()=>{await Promise.all([o.schedule((()=>s=this._setViewpointOfInterest(e,t))),o.schedule((()=>this._applyBasemap(e,t)),t.signal)]),await Promise.all([o.schedule((()=>this._applyLayerVisibility(e)),t.signal),o.schedule((()=>this._applyGround(e)),t.signal),o.schedule((()=>this._applyViewpoint(e,t)),t.signal)]),await o.schedule((()=>e.environment.weather=this.environment.weather.clone()));},p=await a$2(e.addUpdatingPromise(a()));if(s&&(e.contentCamera=null),o.remove(),this._applyToController===i&&(this._applyToController=null),i=null,r?.remove(),!1===p.ok)throw p.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t);}catch(i){if(g(i))throw i}e.map.basemap=d$2(this.basemap,e.map.basemap);}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground));}_getLayers(e){const t=new j;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach((e=>{u$2(e)&&(t.add(e),"layers"in e&&this._collectLayers(e,t));}));}_applyLayerVisibility(e){if(!this.visibleLayers)return;this._getLayers(e.map).forEach((e=>{const t=this.visibleLayers.find((t=>t.id===e.id));e.visible=null!=t;const i=t&&t.sublayerIds,n=B(e);i&&n&&n.forEach((e=>e.visible=i.includes(e.id)));}));}_setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t.ignoreViewpoint||!t.useDestinationCamera)return !1;const i=pe(e,this.viewpoint);return e.contentCamera=i,r$2(i)}async _applyViewpoint(e,t){if(this.viewpoint&&!t.ignoreViewpoint){if(r$2(this.viewpoint.camera)&&(this.viewpoint.camera.fov=e.camera.fov),t.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(this.environment.lighting.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint;}e.environment.applyLighting(this.environment.lighting.clone());}async _animateToLighting(e,t){let i=null;"sun"===e.environment.lighting.type&&"sun"===this.environment.lighting.type&&("global"===e.viewingMode&&(i=this._animateLightingWithCamera(e,e.environment.lighting,this.environment.lighting)),e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,"virtual"===this.environment.lighting.type||"virtual"===e.environment.lighting.type?(e.environment.applyLighting(this.environment.lighting.clone()),"sun"===e.environment.lighting.type&&(e.environment.lighting.cameraTrackingEnabled=!1)):null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);return e.goTo(this.viewpoint,t).then((()=>e.environment.applyLighting(this.environment.lighting.clone()))).finally((()=>{a$3(i),"sun"===e.environment.lighting.type&&(e.environment.lighting.cameraTrackingEnabled=!0);}))}_getTime(e){return [e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e,t,i){const n=new Date(t.date.toString()),[r,o]=this._getTime(n),[s,a]=this._getTime(i.date),p=H$1(o,a),m=e.renderCoordsHelper,h=n$7();m.toRenderCoords(e.camera.position,h);const c=n$7(),d=n$7();r$2(this.viewpoint.camera)&&m.toRenderCoords(this.viewpoint.camera.position,c);const y=new Date;return l$2((()=>e.camera),(e=>{m.toRenderCoords(e.position,d);const i=p$7(h,d),n=p$7(c,d);let a=0;i+n!==0&&(a=i/(i+n));const l=r+(s-r)*a,u=N(o,p*a);t.date=this._setTime(y,l,u);}))}static createFrom(e,t){return (new this).updateFrom(e,t)}};function B(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers.toArray()}function F(e){const t=B(e);if(t)return t.filter((e=>e.visible)).map((e=>e.id))}e$2([d({type:String,json:{write:{isRequired:!0}}})],M.prototype,"id",void 0),e$2([d({type:c,json:{default:()=>new c({text:""}),write:{isRequired:!0}}})],M.prototype,"title",void 0),e$2([s$5("title")],M.prototype,"castTitle",null),e$2([d({type:c$3,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],M.prototype,"description",void 0),e$2([s$5("description")],M.prototype,"castDescription",null),e$2([d({type:p$6,json:{default:()=>new p$6({url:""}),write:{isRequired:!0}}})],M.prototype,"thumbnail",void 0),e$2([s$5("thumbnail")],M.prototype,"castThumbnail",null),e$2([d({type:u$1,nonNullable:!0,json:{write:{isRequired:!0}}})],M.prototype,"viewpoint",void 0),e$2([d({type:x,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],M.prototype,"basemap",void 0),e$2([s$5("basemap")],M.prototype,"castBasemap",null),e$2([d({type:u,json:{write:!0}})],M.prototype,"ground",void 0),e$2([d({type:O,json:{write:{isRequired:!0}}})],M.prototype,"visibleLayers",null),e$2([s$5("visibleLayers")],M.prototype,"castVisibleLayers",null),e$2([d({type:h,json:{write:!0}})],M.prototype,"environment",void 0),M=e$2([n$3("esri.webscene.Slide")],M);const G=86400,P=43200;function H$1(e,t){let i=t-e;return i>P&&(i-=G),i<-P&&(i+=G),i}function N(e,t){return j$1(e+t,G)}const W=M;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const n=j.ofType(W);let m=class extends l$1{constructor(s){super(s),this.slides=new n;}destroy(){this.slides.forEach((s=>s.destroy())),this.slides.removeAll();}set slides(s){s&&(s=s.filter((s=>!!s.viewpoint))),this._set("slides",n$6(s,this._get("slides"),n));}clone(){return new(0,this.constructor)({slides:this.slides.clone()})}};e$2([d({type:n,nonNullable:!0,json:{write:!0}}),s$5(t$1)],m.prototype,"slides",null),m=e$2([n$3("esri.webscene.Presentation")],m);const a=m;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var s;let p=s=class extends l$1{constructor(t){super(t);}clone(){return new s({name:this.name,path:this.path,title:this.title})}};e$2([d({type:String,json:{write:!0}})],p.prototype,"name",void 0),e$2([d({type:String,json:{write:!0}})],p.prototype,"path",void 0),e$2([d({type:String,json:{write:!0}})],p.prototype,"title",void 0),p=s=e$2([n$3("esri.webscene.TransportationNetwork")],p);const i=p;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class e extends r$3{constructor(s,e){super(s,e,"webscene");}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const D=s$4.getLogger("esri.WebScene"),H=new e(1,28),z=()=>{const e=8,t=[],r=H.major;for(let i=e;i<=H.minor;i++)t.push(`${r}.${i}`);return t},Q="Web Scene",X="ViewingMode-Local";let Y=class extends(m$3.LoadableMixin(m$4(O$1(L$1)))){constructor(e){super(e),this._handles=new u$3,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=null,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new a,this.initialViewProperties=new l,this.portalItem=null,this.resourceInfo=null,this._debouncedSaveOperations=x$1((async(e,t,r)=>{switch(e){case Z.SAVE:return this._saveImpl(t);case Z.SAVE_AS:return this._saveAsImpl(r,t)}})),this.resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1;}initialize(){if(this.when().catch((e=>{D.error("#load()","Failed to load web scene",e);})),this.resourceInfo){let t;try{t=this._validateJSON(this.resourceInfo);}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(t),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo());}this._handles.add(this.allLayers.on("change",(()=>this._scheduleLayersIdGC())));}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const e=this.portalItem;this.portalItem=null,e?.destroy();}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON();}readClippingEnabled(e,t){return !!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e);}writeLayers(e,t,r,i){const o={...i,layerContainerType:"operational-layers"},s=e.map((e=>this.verifyWriteLayer(e,i)?e.write({},o):null)).filter((e=>!!e));t[r]=s.toArray();}verifyWriteLayer(e,t){return "write"in e||(t&&t.messages&&t.messages.push(new s$3("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1)}readSourceVersion(e$1,t){const[r,i]=t.version.split(".");return new e(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${H.major}.${H.minor}`;}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"));}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e);}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript";}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e);}writeAuthoringAppVersion(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=s$6;}writeGround(e,t,r,i){t[r]=e?e.write({},i):{transparency:0,layers:[]};}readInitialViewProperties(e,t){const r={};return t.initialState&&t.initialState.environment&&(r.environment=y.fromJSON(t.initialState.environment)),t.spatialReference?r.spatialReference=k.fromJSON(t.spatialReference):r.spatialReference=k.WebMercator,r.viewingMode=t.viewingMode||"global",t.initialState&&t.initialState.viewpoint&&(r.viewpoint=u$1.fromJSON(t.initialState.viewpoint)),new l(r)}get spatialReference(){return this.initialViewProperties?.spatialReference??k.WebMercator}get viewingMode(){return this.initialViewProperties?.viewingMode??"global"}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return n$8(this,(e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map((e=>e.basemap)));}))}read(e,t){t={...t,origin:"web-scene"};const r=this._isAuthoringAppVersionSetByUser,i=this._isAuthoringAppSetByUser;if(d$3(this,e,(t=>super.read(e,t)),t),i||(this._isAuthoringAppSetByUser=!1),r||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){const t=e.baseMap.elevationLayers.map((e=>({id:e.id}))),r=this.presentation.slides,i=(e,t)=>e.visibleLayers.some((e=>e.id===t)),o=t.filter((e=>!r.some((t=>i(t,e.id)))));r.forEach((e=>{e.visibleLayers.addMany(o);}));}}_writeBasemapElevationLayers(e){const t=e.ground&&e.ground.layers;!e.baseMap&&t&&t.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=m$1(t));}write(e,t){if("loaded"!==this.loadStatus){const e=new s$3("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw D.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),e}this._runLayersIdGC();const r=!t?.messages;t={messages:[],...t,origin:"web-scene"};const i=super.write(e,t);if(r){const e=t.messages.filter((e=>"web-document-write:property-required"===e.name));if(e.length){const t=new s$3("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:e});throw D.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",e),t}}return this._writeBasemapElevationLayers(i),i}async save(e){return this._debouncedSaveOperations(Z.SAVE,e)}async _saveImpl(e){this.portalItem||(D.error("save(): requires the .portalItem property to be set"),await Promise.reject(new s$3("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))),this.portalItem.type!==Q&&await Promise.reject(new s$3("webscene:portal-item-wrong-type",`Portal item needs to have type "${Q}"`));const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const r=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&j$2(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||B$1.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),i=this.write({},r);return await Promise.all(r.resources.pendingOperations),await this._verifySave(i,r,e),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:i}),await a$4(this.resourceReferences,r,null),i$8(r),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(Z.SAVE_AS,t,e)}async _saveAsImpl(e,t){let r=b$2.from(e);r||(D.error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new s$3("webscene:portal-item-required","saveAs requires a portal item to save to"))),r.id&&(r=r.clone(),r.id=null);const i=r.portal||B$1.getDefault();await this._ensureLoadBeforeSave(),r.type=Q,r.portal=i;const o=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:i,portalItem:r,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),a=this.write({},o);await Promise.all(o.resources.pendingOperations),await this._verifySaveAs(a,o,t);const n=this.thumbnailUrl,l=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(r),await i._signIn(),await i.user.addItem({item:r,folder:t&&t.folder,data:a}),await a$4(this.resourceReferences,o,null),this.portalItem=r,S$1.prototype.read.call(this,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:r.itemUrl&&j$2(r.itemUrl)}),i$8(o),n&&(this.thumbnailUrl=l?St(n,"w","8192"):n),o.portalItem=r,await this._saveThumbnail(),r}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"));}_verifySave(e,t,r,i=!1){if(!A$2(this.spatialReference))return Promise.reject(new s$3("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let o,a=t.messages.filter((e=>"error"===e.type)).map((e=>new s$3(e.name,e.message,e.details)));t.blockedRelativeUrls&&(a=a.concat(t.blockedRelativeUrls.map((e=>new s$3("url:unsupported",`Relative url '${e}' is not supported in Web Scene`))))),r&&r.ignoreUnsupported&&(a=a.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name&&"scenemodification:unsupported"!==e.name))),r?.requiredPropertyChecksDisabled&&(a=a.filter((e=>"web-document-write:property-required"!==e.name)));const n=r&&r.strictSchemaValidationEnabled;return o=n?import('./schemaValidator-ec9b61c4.js').then((t=>{const r=t.validate(e);if(r.length>0){const e=`webscene did not validate:\n${r.join("\n")}`;D.error(`${i?"saveAs":"save"}(): ${e}`);}return r.map((e=>new s$3("webscene:schema-validation",e)))})).then((e=>{if(n&&e.length>0){throw s$2(e.concat(a))}return a})):Promise.resolve(a),o.then((e=>{if(e.length>0)throw new s$3("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:e})}))}_verifySaveAs(e,t,r){return this.canNotSaveAs(t)?Promise.reject(n$2()):this._verifySave(e,t,r,!0)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),r=this.write({},t);return this._verifySaveAs(r,t,e)}canNotSaveAs(e){return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.length>0}async updateFrom(e,t={}){const r=this._updateFrom(e,t);this._updateFromPromise=r,await r;this._updateFromPromise===r&&(this._updateFromPromise=null);}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=y.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,r$2(e.clippingArea)?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const r of e.allLayerViews){const e="visible";e in r&&e in r.layer&&r._isOverridden(e)&&(r.layer[e]=r[e]);}(!1===t.thumbnailExcluded||null==t.thumbnailExcluded&&!t.viewpointExcluded)&&await this._updateFromThumbnail(e,t.thumbnailSize||void 0);}async _updateFromThumbnail(e,t){const r=i$9(e,t),i=await e.takeScreenshot({format:"jpg",width:r.width,height:r.height,disableDecorations:!0});this.thumbnailUrl=i.dataUrl;}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){const r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const o of e.baseMap.elevationLayers)t.push(o);const r=[],i=e=>(e.layers&&(e.layers=e.layers.filter(i)),"ArcGISTiledElevationServiceLayer"!==e.layerType||(this.sourceVersion.supportsGround||r.push(e),!1));return {operationalLayers:e.operationalLayers?e.operationalLayers.filter(i):[],operationalElevationLayers:r,basemapElevationLayers:t}}_loadFromJSON(e,t){const r=new j;return this._validateSpatialReference().then((()=>this._validateHeightModelInfo())).then((()=>import('./layersCreator-b914b652.js'))).then((({populateOperationalLayers:i})=>{const{operationalLayers:o,operationalElevationLayers:s,basemapElevationLayers:a}=this._extractOperationalLayers(e),n=[],l={context:{...t,layerContainerType:"operational-layers"}};if(this.portalItem&&(l.context.portal=this.portalItem.portal||B$1.getDefault()),a.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(this.ground.layers,a,e));}if(s.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(r,s,e));}return o&&o.length>0&&n.push(i(this.layers,o,l)),E(n).then((()=>{}))})).then((()=>this._loadObjectsWithLayers())).then((()=>{this.ground.layers.addMany(r);}))}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[];for(const t of this.allLayers.items)if("beforeSave"in t&&"function"==typeof t.beforeSave){const r=t.beforeSave();r&&e.push(r);}await E(e);}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach((t=>{t.basemap&&e.push(t.basemap.load());})),await E(e);}async _loadFromItem(e){if(await e.load().catch((e=>{throw new s$3("webscene:load-portal-item","Failed to load portal item",{error:e})})),"Web Scene"!==e.type)throw new s$3("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const r={origin:"web-scene",url:j$2(e.itemUrl),portal:e.portal||B$1.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,r),this.resourceReferences={portalItem:e,paths:r.readResourcePaths};}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let r;if("local"!==e.viewingMode){if(!r$4(t,l$3.Global))return Promise.reject(new s$3("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||An(e,t);}else {if(!r$4(t,l$3.Local))return Promise.reject(new s$3("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||e.equals(t);}const i=e=>e&&(r$2(e.camera)&&e.camera.position&&e.camera.position.spatialReference||r$2(e.targetGeometry)&&e.targetGeometry.spatialReference),o=e.viewpoint,a=i(o);if(a&&!r(a))return Promise.reject(new s$3("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}));const n=this.presentation.slides.find((e=>!r(i(e.viewpoint))));if(n){const r=i(n.viewpoint);return Promise.reject(new s$3("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:r,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=r$5(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateJSON(e$1){const t=e.parse(e$1.version||"","webscene");return H.validate(t),e$1.version=`${t.major}.${t.minor}`,1===t.major&&t.minor<=2&&(e$1.spatialReference=k.WebMercator.toJSON()),e$1}_updateTypeKeywords(e){"local"===this.initialViewProperties.viewingMode?e.typeKeywords?e.typeKeywords.includes(X)||e.typeKeywords.push(X):e.typeKeywords=[X]:"global"===this.initialViewProperties.viewingMode&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e=>e!==X))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)));}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||k.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem&&this.portalItem.itemUrl?j$2(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0);}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout((()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC();}),3e3);}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,t=e=>this.allLayers.some((t=>t.id===e));e&&e.layers&&(e.layers=e.layers.filter((e=>t(e.id))));const r=this.presentation&&this.presentation.slides;r&&r.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>t(e.id))));}));}static fromJSON(e){if(!e)throw new s$3("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};var Z;Y.VERSION=H,e$2([d({type:c$5,json:{write:!0}})],Y.prototype,"applicationProperties",void 0),e$2([d({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],Y.prototype,"basemap",void 0),e$2([d({type:M$1,json:{read:{source:"clippingArea.geometry",reader:d$4},write:{target:"clippingArea.geometry"}}})],Y.prototype,"clippingArea",void 0),e$2([r$6("clippingArea")],Y.prototype,"writeClippingArea",null),e$2([d({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],Y.prototype,"clippingEnabled",void 0),e$2([o$1("clippingEnabled",["clippingArea"])],Y.prototype,"readClippingEnabled",null),e$2([r$6("clippingEnabled")],Y.prototype,"writeClippingEnabled",null),e$2([d({type:l$4,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],Y.prototype,"floorInfo",void 0),e$2([d({type:v,json:{write:!0}})],Y.prototype,"heightModelInfo",void 0),e$2([d({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],Y.prototype,"layers",void 0),e$2([r$6("layers")],Y.prototype,"writeLayers",null),e$2([d({readOnly:!0,type:e,json:{type:z(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],Y.prototype,"sourceVersion",void 0),e$2([o$1("sourceVersion",["version"])],Y.prototype,"readSourceVersion",null),e$2([r$6("sourceVersion")],Y.prototype,"writeSourceVersion",null),e$2([d({json:{read:!1,write:!1}})],Y.prototype,"tables",void 0),e$2([d()],Y.prototype,"thumbnailUrl",null),e$2([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Y.prototype,"authoringApp",null),e$2([r$6("authoringApp")],Y.prototype,"writeAuthoringApp",null),e$2([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Y.prototype,"authoringAppVersion",null),e$2([r$6("authoringAppVersion")],Y.prototype,"writeAuthoringAppVersion",null),e$2([d({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],Y.prototype,"ground",void 0),e$2([r$6("ground")],Y.prototype,"writeGround",null),e$2([d({type:j.ofType(i),json:{write:!0}})],Y.prototype,"transportationNetworks",void 0),e$2([d({type:a,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,r,i)=>{if(e.slides&&e.slides.length>0){const r={...i,isPresentation:!0};t.presentation=e.write({},r);}}}}})],Y.prototype,"presentation",void 0),e$2([d({type:l,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new l({viewingMode:"global",spatialReference:k.WebMercator})}})],Y.prototype,"initialViewProperties",void 0),e$2([o$1("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],Y.prototype,"readInitialViewProperties",null),e$2([d({type:k,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Y.prototype,"spatialReference",null),e$2([d({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Y.prototype,"viewingMode",null),e$2([d({type:b$2})],Y.prototype,"portalItem",void 0),e$2([d()],Y.prototype,"resourceInfo",void 0),Y=e$2([n$3("esri.WebScene")],Y),function(e){e[e.SAVE=0]="SAVE",e[e.SAVE_AS=1]="SAVE_AS";}(Z||(Z={}));const ee=Y;

export default ee;
