import { s as s$1, y as y$1, h as e, r, t, e as e$1, d, n as n$1, bm as y$3, bn as v, a as s$3 } from './cast-3d5be210.js';
import './geometry-2f332a26.js';
import { o as o$1, O as O$1, u, a as o$2 } from './mathUtils-559a53d9.js';
import { j } from './reactiveUtils-bd6fe823.js';
import { Z as Z$1 } from './unitUtils-a0a11e54.js';
import { WhereClause as m } from './WhereClause-ae6d22ff.js';
import { b as bn, t as tn, r as rn, B as Bn } from './projection-fbd5d346.js';
import { a, G as G$1 } from './aaBoundingBox-b312516d.js';
import { o, x as x$1, h as h$1, E, u as u$2 } from './aaBoundingRect-5e1a4e52.js';
import { M, k, s as s$2 } from './Point-edff2a11.js';
import { y as y$2 } from './labelingInfo-6e0c44d1.js';
import { ad as le, a3 as ce, a4 as Me } from './SceneView-ed3703c9.js';
import { u as u$1 } from './Handles-54afc0a7.js';
import { M as M$1 } from './Extent-f27111e1.js';
import { Y } from './QueryEngine-115f26ee.js';
import x$2 from './FeatureSet-1b85367a.js';
import { b } from './Query-1f6c7e43.js';
import { e as e$2 } from './centroid-a69e0a54.js';
import { t as t$1 } from './OptimizedFeature-a0dba562.js';
import { n as n$2 } from './Collection-a38e0489.js';
import { n as n$3 } from './vec4f64-011248e0.js';
import { L as L$1 } from './I3SMeshView3D-e92cb051.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const D=s$1.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let C=class extends y$1{constructor(e){super(e),this._projectionEngineLoaded=!1;}initialize(){j((()=>e(this.viewFilter)?.geometry||r(this.layerFilter))).then((()=>this.loadAsyncModule(import('./geometryEngine-4d921600.js').then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters());})))));}get sortedObjectIds(){if(t(this.viewFilter)||t(this.viewFilter.objectIds))return null;const e=new Float64Array(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=r(this.viewFilter)?this.viewFilter.where:null;if(t(e)||!e)return null;try{return m.create(e,this.layerFieldsIndex)}catch(t){D.error(`Failed to parse filter where clause: ${t}`);}return null}addFilters(e,t,r$1,i){const s=this.sortedObjectIds;r(s)&&e.push((e=>le(s,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const o=this._layerMaskGeometries,n=this._geometryEngine;if(r(o)&&r(this.layerFilter)&&r(n)){const s=this.layerFilter.spatialRelationship;e.push(((e,a)=>L(n,e,a,i,t,r$1,o,s)));}const l=this._viewMaskGeometries;if(r(l)&&r(this.viewFilter)&&r(n)){const s=this.viewFilter.spatialRelationship;e.push(((e,o)=>L(n,e,o,i,t,r$1,l,s)));}}isMBSGeometryVisible(e,t,r$1){const i=this._layerMaskGeometries,s=this._geometryEngine;if(r(i)&&r(this.layerFilter)&&r(s)){const o=this.layerFilter.spatialRelationship,n=i[0].spatialReference||t;if(!bn(e,r$1,W,n))return D.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return B(s,W,i,n,o)}const o=this._viewMaskGeometries;if(r(o)&&r(this.viewFilter)&&r(s)){const i=this.viewFilter.spatialRelationship,n=o[0].spatialReference||t;if(!bn(e,r$1,W,n))return D.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return B(s,W,o,n,i)}return !0}get parsedGeometry(){const e=this._viewMaskGeometries,t$1=this._layerMaskGeometries;return t(e)||t(t$1)?e||t$1:t$1.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return t(e)||t(this._geometryEngine)?null:O(this._geometryEngine,e.geometry,e.spatialRelationship)}get _viewMaskGeometries(){if(t(this.viewFilter)||t(this._geometryEngine))return null;const{geometry:e}=this.viewFilter;if(t(e))return null;const{distance:t$1,units:r$1}=this.viewFilter,i=this.viewFilter.spatialRelationship,s="mesh"===e.type?e.extent:e;if(t(t$1)||0===t$1)return O(this._geometryEngine,s,i);const o=r$1||Z$1(s.spatialReference);if(s.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(s,t$1,o);return O(this._geometryEngine,e,i)}const l=M(s,k.WGS84);if(r(l)){const e=M(this._geometryEngine.geodesicBuffer(l,t$1,o),s.spatialReference);return O(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(tn().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let c=null;try{c=rn(s,k.WGS84);}catch(u){}if(c)try{c=rn(this._geometryEngine.geodesicBuffer(c,t$1,o),s.spatialReference);}catch(u){c=null;}return c||D.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${s.spatialReference.wkid}) to WGS84.`),O(this._geometryEngine,c,i)}static checkSupport(e){return !t(e)&&(e.timeExtent?(D.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!A(e.spatialRelationship)||(D.warn(`Filters with spatialRelationship other than ${G.join(", ")} are not supported for mesh scene layers`),!1))}};e$1([d()],C.prototype,"layerFilter",void 0),e$1([d({type:y$2})],C.prototype,"viewFilter",void 0),e$1([d()],C.prototype,"layerFieldsIndex",void 0),e$1([d()],C.prototype,"loadAsyncModule",void 0),e$1([d()],C.prototype,"applyFilters",void 0),e$1([d()],C.prototype,"addSqlFilter",void 0),e$1([d({readOnly:!0})],C.prototype,"sortedObjectIds",null),e$1([d({readOnly:!0})],C.prototype,"parsedWhereClause",null),e$1([d({readOnly:!0})],C.prototype,"parsedGeometry",null),e$1([d({readOnly:!0})],C.prototype,"_layerMaskGeometries",null),e$1([d({readOnly:!0})],C.prototype,"_viewMaskGeometries",null),e$1([d()],C.prototype,"_projectionEngineLoaded",void 0),e$1([d()],C.prototype,"_geometryEngine",void 0),C=e$1([n$1("esri.views.3d.layers.i3s.I3SMeshViewFilter")],C);const G=(e=>e)(["contains","intersects","disjoint"]);function A(e){return null!=e&&G.includes(e)}var x;function O(e,t$1,s){if(t(t$1))return null;if("disjoint"===s&&"polygon"===t$1.type){const s=new Array(t$1.rings.length);for(let e=0;e<t$1.rings.length;++e){const r=o(1/0,1/0,-1/0,-1/0);x$1(r,t$1.rings[e]),s[e]={type:"polygon",rings:[t$1.rings[e]],spatialReference:t$1.spatialReference,aabr:r};}s.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const o$1=new Set,n=new y$3;for(let t=0;t<s.length;++t){const r=s[t];for(let e=t+1;e<s.length;++e){const t=s[e];if(t.aabr[0]>=r.aabr[2])break;o$1.add(t);}o$1.forEach((t=>{if(r!==t)if(t.aabr[2]<=r.aabr[0])o$1.delete(t);else if(e.intersects(r,t)){r.rings=r.rings.concat(t.rings),h$1(r.aabr,t.aabr,r.aabr),delete r._geVersion,o$1.delete(t);const e=v(s,t,s.length,n);s.splice(e,1);}})),o$1.add(r);}for(const e of s)delete e.aabr;return s}return [t$1]}function B(e,t,r,i,s){const o=K(e,t,i);return r.every((t=>V(e,t,o,s)!==x.DISCARD))}function L(e,t,r,i,s,o,n,a){const l=n[0].spatialReference||s.spatialReference;if(!bn(r.node.mbs,o,W,l))return void D.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=K(e,W,l),p=P(a,s,l,i,r.objectHandle);for(const u of n){if(0===t.length)return;switch(V(e,u,c,a)){case x.DISCARD:return void(t.length=0);case x.KEEP:continue}ce(t,r.featureIds,(t=>Z(e,u,t,p)));}}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST";}(x||(x={}));const W=[0,0,0,0];function P(e,t,r,i,s){const o=t.renderSpatialReference,n=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let c,p;switch(e){case"intersects":c=(e,t,r)=>e.intersects(t,r)?x.KEEP:x.TEST,p=U;break;case"contains":c=(e,t,r)=>e.contains(t,r)?x.TEST:x.DISCARD,p=U;break;default:c=(e,t,r)=>e.disjoint(t,r)?x.TEST:x.DISCARD,p=q;}return {collection:i,object:s,type:e,maskSR:r,renderSR:o,aabbCache:n,triangle:a,positions:l,triangleTest:c,geometryTest:p}}function K(e,t,r){const i={x:t[0],y:t[1],hasZ:!1,hasM:!1,type:"point",spatialReference:r},s=!r.isWGS84&&!r.isWebMercator,n=Number.isNaN(t[3])?0:o$1(t[3],0,2*s$2.radius),a=s?e.buffer(i,n,1):e.geodesicBuffer(i,n,1);return a.type="polygon",a}function V(e,t,r,i){switch(i){case"intersects":case"contains":return U(e,t,r);case"disjoint":return q(e,t,r)}}function U(e,t,r){return e.intersects(t,r)?e.contains(t,r)?x.KEEP:x.TEST:x.DISCARD}function q(e,t,r){return e.intersects(t,r)?e.contains(t,r)?x.DISCARD:x.TEST:x.KEEP}const N=2**-32;function Z(e,t,r,i){const{collection:s,object:o,renderSR:n,maskSR:a,geometryTest:l,aabbCache:c}=i;let p=c.get(r);if(!p){const e=s.getObjectTransform(o);s.getComponentAabb(o,r,$);const t=[[$[0],$[1],0],[$[0],$[4],0],[$[3],$[4],0],[$[3],$[1],0]];for(let r=0;r<4;++r)O$1(t[r],t[r],e.rotationScale),u(t[r],t[r],e.position),Bn(t[r],n,t[r],a);p={rings:[t],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a},p.rings[0][4]=p.rings[0][0],c.set(r,p);}switch(l(e,t,p)){case x.DISCARD:return !1;case x.KEEP:return !0}const{triangle:u$1,triangleTest:g,positions:h}=i,m=u$1.rings[0][0],S=u$1.rings[0][1],j=u$1.rings[0][2],E=s.getObjectTransform(o);s.getComponentPositions(o,r,h);const{indices:b,data:R,stride:F,startIndex:v,endIndex:_}=h;for(let I=v;I<_;I+=3){const r=F*b[I+0],i=F*b[I+1],s=F*b[I+2];o$2(m,R[r+0],R[r+1],R[r+2]),o$2(S,R[i+0],R[i+1],R[i+2]),o$2(j,R[s+0],R[s+1],R[s+2]),O$1(m,m,E.rotationScale),O$1(S,S,E.rotationScale),O$1(j,j,E.rotationScale),u(m,m,E.position),u(S,S,E.position),u(j,j,E.position),Bn(m,n,m,a),Bn(S,n,S,a),Bn(j,n,j,a);const o=S[0]-m[0],l=S[1]-m[1],c=j[0]-m[0],p=j[1]-m[1];if(!(Math.abs(o*p-l*c)<N))switch(delete u$1._geVersion,g(e,t,u$1)){case x.DISCARD:return !1;case x.KEEP:return !0}}return "intersects"!==i.type}const $=a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const l$1=Y;let p=class extends y$1{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new u$1;}get defaultQueryJSON(){return new b({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))));}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null);}async executeQueryForCount(e,r){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return {count:t,extent:M$1.fromJSON(s)}}async executeQueryForIds(e,r){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQuery(e,r){const s=this._ensureQueryJSON(e);if(s.returnGeometry)throw new s$3("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(s.returnCentroid)throw new s$3("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const n=await this.dataQueryEngine.executeQuery(s,r),o=x$2.fromJSON(n);return o.features.forEach((e=>{e.geometry=null;})),o}_ensureQueryJSON(e){return t(e)?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",r="esriGeometryPolygon",t=this.layer.fields.map((e=>e.toJSON())),s=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),o=this.priority,i=this.spatialIndex;return this._dataQueryEngineInstance=new l$1({hasZ:!0,hasM:!1,geometryType:r,fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:i,scheduler:s,priority:o}),this._dataQueryEngineInstance}};e$1([d({constructOnly:!0})],p.prototype,"layerView",void 0),e$1([d({constructOnly:!0})],p.prototype,"priority",void 0),e$1([d({constructOnly:!0})],p.prototype,"spatialIndex",void 0),e$1([d({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],p.prototype,"spatialReference",void 0),e$1([d({readOnly:!0,aliasOf:"layerView.i3slayer"})],p.prototype,"layer",void 0),e$1([d({readOnly:!0})],p.prototype,"defaultQueryJSON",null),p=e$1([n$1("esri.views.3d.layers.i3s.I3SQueryEngine")],p);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class n{constructor(t){this.objectIdField=t.objectIdField,this.getFeatureExtent=t.getFeatureExtent;}getObjectId(t){return t.id}getAttributes(e){const{meta:r$1,index:o}=e,n={};this.objectIdField&&(n[this.objectIdField]=e.id);const s=r(r$1.attributeInfo)&&r$1.attributeInfo.attributeData;if(r(s))for(const t of Object.keys(s))n[t]=Me(s[t],o);return n}getAttribute(e,r$1){if(r$1===this.objectIdField)return e.id;const{meta:o,index:n}=e,s=r(o.attributeInfo)&&o.attributeInfo.attributeData;return r(s)?Me(s[r$1],n):null}getGeometry(t){if(t.geometry)return t.geometry;const[e,r,i,n,a]=this.getFeatureExtent(t,s);return new t$1([5],[e,r,i,n,r,i,n,a,i,e,a,i,e,r,i])}getCentroid(t,e){if(t.geometry)return e$2(new t$1,t.geometry,e.hasZ,e.hasM);const[i,n,a,m,u,d]=this.getFeatureExtent(t,s);return new t$1([0],[(i+m)/2,(n+u)/2,(a+d)/2])}cloneWithGeometry(t,e){const{id:r,index:o,meta:i}=t;return {id:r,index:o,meta:i,geometry:e}}}const s=a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let f=class extends y$1{constructor(r){super(r),this.events=new n$2;}forEach(r){this.forAllFeatures((t=>(r(t),L$1.CONTINUE)));}forEachBounds(r,t,e){const o=this.getFeatureExtent;for(const s of r)t(o(s,e));}forEachInBounds(r,t){this.forAllFeatures((e=>{const o=this.getFeatureExtent(e,y);return E(r,G$1(o,h))&&t(e),L$1.CONTINUE}),(t=>{if(bn(t.node.mbs,this.sourceSpatialReference,l,this.viewSpatialReference),l[0]>=r[0]&&l[2]<=r[2]&&l[1]>=r[1]&&l[3]<=r[3])return L$1.CONTINUE;const e=Math.max(r[0],Math.min(l[0],r[2])),o=Math.max(r[1],Math.min(l[1],r[3])),s=l[0]-e,c=l[1]-o;return s*s+c*c<=l[3]*l[3]?L$1.CONTINUE:L$1.SKIP}));}};e$1([d({constructOnly:!0})],f.prototype,"featureAdapter",void 0),e$1([d({constructOnly:!0})],f.prototype,"toArray",void 0),e$1([d({constructOnly:!0})],f.prototype,"forAllFeatures",void 0),e$1([d({constructOnly:!0})],f.prototype,"getFeatureExtent",void 0),e$1([d({constructOnly:!0})],f.prototype,"sourceSpatialReference",void 0),e$1([d({constructOnly:!0})],f.prototype,"viewSpatialReference",void 0),f=e$1([n$1("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],f);const l=n$3(),y=a(),h=u$2();

export { C, f, n, p };
