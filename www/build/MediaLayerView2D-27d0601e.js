import { r, u as r$1, s, a as s$1, t, h as e$1, J as g, aB as r$5, e as e$2, d, n as n$1 } from './cast-3d5be210.js';
import './geometry-2f332a26.js';
import { j } from './Collection-a38e0489.js';
import { l, h, f, a as a$2 } from './reactiveUtils-bd6fe823.js';
import { u as u$2 } from './aaBoundingRect-5e1a4e52.js';
import { s as s$2, M as M$2 } from './Extent-f27111e1.js';
import { a as a$3 } from './mediaUtils-3e05c43b.js';
import { p, r as r$4 } from './TileStrategy-fea1cb17.js';
import './TileStore-909b46c6.js';
import './TileKey-97254206.js';
import { ah as i } from './mathUtils-559a53d9.js';
import { a } from './DisplayObject-f25c6d04.js';
import { c, f as f$1 } from './FramebufferObject-bfb23fd2.js';
import { P, G, L, D, F } from './enums-4770f29d.js';
import { n, u } from './Texture-f189b7ba.js';
import { c as c$1 } from './screenUtils-31d073db.js';
import { r as r$2, i as i$1, M as M$1, f as f$2, h as h$1 } from './mat3-eb8de168.js';
import { M as e, Q as mt } from './DefaultUI-a0db5719.js';
import { t as t$1 } from './vec2f32-23e4a539.js';
import { r as r$3 } from './vec3f32-03e33744.js';
import { z } from './normalizeUtils-d37dc597.js';
import { b as R$1 } from './Point-edff2a11.js';
import { W } from './brushes-f4d4256e.js';
import { I } from './Utils-b4b0f45e.js';
import { a as a$1 } from './WGLContainer-fea967fb.js';
import { f as f$3 } from './LayerView2D-2fae06b5.js';
import { u as u$1 } from './LayerView-1ee5d9ed.js';
import './Polyline-dcdb3782.js';
import './request-ac4d8bfb.js';
import './projection-fbd5d346.js';
import './unitUtils-a0a11e54.js';
import './mat4-d5df0e58.js';
import './assets-99f5c3ee.js';
import './zscale-0befeff4.js';
import './normalizeUtilsSync-1f2b7f6d.js';
import './vec2-4f9a494f.js';
import './workers-c7a27acb.js';
import './intl-54ccdc89.js';
import './number-c5a37d3e.js';
import './Promise-d2759b2e.js';
import './messages-5e9a4a9e.js';
import './quickselect-d6c9284c.js';
import './Query-1f6c7e43.js';
import './TimeExtent-66b53603.js';
import './JSONSupport-dce2c67b.js';
import './enumeration-6695a859.js';
import './Field-2973a5cf.js';
import './fieldType-eb0b42e4.js';
import './context-util-5ae1bf7b.js';
import './Handles-54afc0a7.js';
import './jsxFactory-4cd653a4.js';
import './uuid-ac104993.js';
import './index-f980186a.js';
import './HandleOwner-fe336959.js';
import './Feature-d7b2670c.js';
import './aliasOf-bdfe6662.js';
import './byteSizeEstimations-5d50d6ff.js';
import './Cyclical-922b1741.js';
import './Graphic-93f45ded.js';
import './PopupTemplate-b459951f.js';
import './fieldUtils-240a3b99.js';
import './ActionToggle-a5849e6f.js';
import './Identifiable-d9658370.js';
import './symbols-ab3e849a.js';
import './CIMSymbol-15bdb580.js';
import './Symbol-573a64f6.js';
import './Color-25ce730a.js';
import './colorUtils-5009883d.js';
import './opacityUtils-dcd94f00.js';
import './aaBoundingBox-b312516d.js';
import './persistableUrlUtils-5dcd6081.js';
import './collectionUtils-302901c0.js';
import './Portal-5df9f5a7.js';
import './Clonable-533c7a05.js';
import './executeQueryJSON-cbafa4d9.js';
import './utils-d801fb7f.js';
import './query-993c240b.js';
import './pbfQueryUtils-266d53dd.js';
import './pbf-bac0c6a4.js';
import './OptimizedFeature-a0dba562.js';
import './OptimizedFeatureSet-261a115b.js';
import './queryZScale-127601ac.js';
import './FeatureSet-1b85367a.js';
import './TopFeaturesQuery-babc7c57.js';
import './utils-112c7fa0.js';
import './ColorStop-64c57e35.js';
import './utils-2bda91e5.js';
import './asyncUtils-96c00c9e.js';
import './jsonUtils-f3f35e7f.js';
import './_commonjsHelpers-8dd5c177.js';
import './ItemCache-1f62ab56.js';
import './MemCache-04cdd0cd.js';
import './utils-8133dc40.js';
import './jsonUtils-e7c7add9.js';
import './UniqueValueRenderer-bb66af10.js';
import './diffUtils-6436a697.js';
import './colorRamps-e3d9340f.js';
import './sizeVariableUtils-5330814d.js';
import './compilerUtils-d149ad5f.js';
import './commonProperties-fca3036e.js';
import './jsonUtils-a25e8eb8.js';
import './styleUtils-d2332fad.js';
import './DictionaryLoader-d0d1b4ff.js';
import './LRUCache-5f25d277.js';
import './heatmapUtils-d302cc7f.js';
import './vec4f64-011248e0.js';
import './widget-a58988b6.js';
import './vmEvent-c5708c9c.js';
import './themeUtils-b1f4a2e4.js';
import './featureConversionUtils-3f60eb15.js';
import './languageUtils-d37e9fbb.js';
import './number-3228daf9.js';
import './FeatureLayer-6922c890.js';
import './MultiOriginJSONSupport-281c1c62.js';
import './sql-817bbae7.js';
import './HeightModelInfo-12951268.js';
import './Layer-569a1fc8.js';
import './APIKeyMixin-04df9c0f.js';
import './ArcGISService-848d76dd.js';
import './arcgisLayerUrl-a268a370.js';
import './BlendLayer-7884099a.js';
import './CustomParametersMixin-f702935f.js';
import './labelingInfo-6e0c44d1.js';
import './LabelClass-936eaa93.js';
import './labelUtils-824fc88a.js';
import './defaultsJSON-5fb6161d.js';
import './OperationalLayer-e04486e0.js';
import './OrderedLayer-d02e1d58.js';
import './PortalLayer-e61e1a42.js';
import './PortalItem-fa114dd2.js';
import './RefreshableLayer-496830b9.js';
import './ScaleRangeLayer-f9a9951f.js';
import './TemporalLayer-6cfc496a.js';
import './TimeInfo-0c128ef4.js';
import './FeatureType-691faa46.js';
import './fieldProperties-fa42dff4.js';
import './FieldsIndex-ea481e79.js';
import './LayerFloorInfo-b83a3647.js';
import './versionUtils-55e187fe.js';
import './styleUtils-106413c0.js';
import './popupUtils-883a107f.js';
import './symbolUtils-7f5a2832.js';
import './colorUtils-e0bbe79f.js';
import './mat2d-677a80fe.js';
import './GoTo-929e809f.js';
import './Map-3fa127ca.js';
import './Basemap-bccaf827.js';
import './loadAll-0acccebb.js';
import './writeUtils-ab23132f.js';
import './layerUtils-160a1a44.js';
import './CollectionFlattener-9ce72729.js';
import './TablesMixin-6752cfb1.js';
import './GraphicsCollection-851bdafb.js';
import './Scheduler-ed7a36dc.js';
import './heightModelInfoUtils-4737da37.js';
import './ViewingMode-4a1cffad.js';
import './Viewpoint-e3d4029a.js';
import './vec2f64-2956001b.js';
import './capabilities-cb32c85a.js';
import './pixelUtils-e251d269.js';
import './DefaultVertexAttributeLayouts-664d07a8.js';
import './VertexElementDescriptor-3b53aa99.js';
import './enums-395c521f.js';
import './ProgramTemplate-6f185b1d.js';
import './Program-634dbdbe.js';
import './MaterialKey-ac9b534a.js';
import './alignmentUtils-4bbd02ca.js';
import './utils-84240eaf.js';
import './number-ad66b701.js';
import './StyleDefinition-8856d24f.js';
import './config-5446e136.js';
import './GeometryUtils-744eb819.js';
import './Container-9c6fdd22.js';
import './EffectView-a2b02e73.js';
import './earcut-4e6b97b1.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class _ extends a{constructor(s$2){super(),this.elementView=s$2,this.isWrapAround=!1,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(l((()=>this.elementView.element.opacity),(e=>this.opacity=e),h),l((()=>[this.elementView.coords]),(()=>{this.requestRender();}),h),f((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&r(e.content)&&this._handles.push(r$1(e.content,"play",(()=>this.requestRender())));}),h)),s$2.element.load().catch((t=>{s.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new s$1("element-load-error","Element cannot be displayed",{element:s$2,error:t}));}));}destroy(){this._handles.forEach((e=>e.remove())),this.texture?.dispose(),this.texture=null;}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,r$1=this.elementView.element.content;if(r(r$1)){const e=r$1 instanceof HTMLImageElement,i$1=r$1 instanceof HTMLVideoElement,o=e?r$1.naturalWidth:i$1?r$1.videoWidth:r$1.width,n$1=e?r$1.naturalHeight:i$1?r$1.videoHeight:r$1.height;this.texture?i$1&&!r$1.paused&&(this.texture.setData(r$1),this.requestRender(),(n(t.gl)||i(o)&&i(n$1))&&this.texture.generateMipmap()):(this.texture=new u(t,{pixelFormat:P.RGBA,dataType:G.UNSIGNED_BYTE,samplingMode:L.LINEAR,wrapMode:D.CLAMP_TO_EDGE,width:o,height:n$1},r$1),(n(t.gl)||i(o)&&i(n$1))&&this.texture.generateMipmap(),i$1&&!r$1.paused&&this.requestRender());}super.beforeRender(e);}_createTransforms(){return null}updateDrawCoords(e,t$1){const r=this.elementView.coords;if(t(r))return;const[s,i,n,a]=r.rings[0],h=this._vertices,{x:m,y:l}=e,d=0!==t$1;d?h.set([i[0]-m,i[1]-l,s[0]-m,s[1]-l,n[0]-m,n[1]-l,a[0]-m,a[1]-l,a[0]-m,a[1]-l,i[0]+t$1-m,i[1]-l,i[0]+t$1-m,i[1]-l,s[0]+t$1-m,s[1]-l,n[0]+t$1-m,n[1]-l,a[0]+t$1-m,a[1]-l]):h.set([i[0]-m,i[1]-l,s[0]-m,s[1]-l,n[0]-m,n[1]-l,a[0]-m,a[1]-l]),this.isWrapAround=d;}getVAO(e,t$1,r){if(t(this.elementView.coords))return null;const s=this._vertices;if(this._vao)this._geometryVbo.setData(s);else {this._geometryVbo=c.createVertex(e,F.DYNAMIC_DRAW,s);const i=c.createVertex(e,F.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new f$1(e,r,t$1,{geometry:this._geometryVbo,tex:i});}return this._vao}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class M extends a$1{constructor(){super(...arguments),this._localOrigin=c$1(0,0),this._viewStateId=-1,this._dvsMat3=e(),this.requiresDedicatedFBO=!1;}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const e of this.children)e.beforeRender(t);}prepareRenderPasses(t){const e=t.registerRenderPass({name:"overlay",brushes:[W.overlay],target:()=>this.children,drawPhase:I.MAP});return [...super.prepareRenderPasses(t),e]}_updateMatrices(t){const{state:e}=t,{id:n,size:l,pixelRatio:m,resolution:h,rotation:f,viewpoint:u,displayMat3:M}=e;if(this._viewStateId===n)return;const v=Math.PI/180*f,_=m*l[0],w=m*l[1],{x:y,y:j}=u.targetGeometry,g=z(y,e.spatialReference);this._localOrigin.x=g,this._localOrigin.y=j;const b=h*_,R=h*w,O=r$2(this._dvsMat3);i$1(O,O,M),M$1(O,O,t$1(_/2,w/2)),f$2(O,O,r$3(_/b,-w/R,1)),h$1(O,O,-v),this._viewStateId=n;}_updateOverlays(e,s){const{state:r}=e,{rotation:o,spatialReference:a,worldScreenWidth:i,size:n,viewpoint:c}=r,p=this._localOrigin;let d=0;if(a.isWrappable){const e=n[0],h=n[1],f=180/Math.PI*o,u=Math.abs(Math.cos(f)),M=Math.abs(Math.sin(f)),v=Math.round(e*u+h*M),[_,w]=R$1(a).valid,y=mt(a),{x:j,y:g}=c.targetGeometry,b=[j,g],R=[0,0];r.toScreen(R,b);const O=[0,0];let P;P=v>i?.5*i:.5*v;const x=Math.floor((j+.5*y)/y),C=_+x*y,D=w+x*y,I=[R[0]+P,0];r.toMap(O,I),O[0]>D&&(d=y),I[0]=R[0]-P,r.toMap(O,I),O[0]<C&&(d=-y);for(const r of s){const e=r.elementView.bounds;if(t(e))continue;const[s,,o]=e;s<_&&o>_?r.updateDrawCoords(p,y):o>w&&s<w?r.updateDrawCoords(p,-y):r.updateDrawCoords(p,d);}}else for(const t of s)t.updateDrawCoords(p,d);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let w=class extends(f$3(u$1)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new j;}attach(){this.handles.add(a$2((()=>this.layer.source),"refresh",(()=>{for(const e of this._tileStrategy.tiles)this._updateTile(e);this.requestUpdate();}))),this._overlayContainer=new M,this.container.addChild(this._overlayContainer),this._fetchQueue=new p({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new r$4({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate();}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear();}supportsSpatialReference(e){return !0}moveStart(){this.requestUpdate();}viewChange(){this.requestUpdate();}moveEnd(){this.requestUpdate();}update(e){this._tileStrategy.update(e);}async hitTest(e,t){const s=[],r$1=[e.x,e.y];for(const l of this.elements){const t=e$1(l.georeference)?.coords;r(t)&&s$2(t.rings,r$1)&&s.push({type:"media",element:l,layer:this.layer,mapPoint:e});}return s.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){}_acquireTile(e){const t=new R(e.clone());return this._updateTile(t),t}_updateTile(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[s,r]=e.setElements(t);this._acquireElements(e,s),this._releaseElements(e,r),this.requestUpdate();}),(e=>{g(e)||s.getLogger(this.declaredClass).error(e);})));}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._releaseElements(e,e.elements),this.requestUpdate();}async _queryElements(e,t$1){const s=this.layer.source;if(t(s))return [];this.view.featuresTilingScheme.getTileBounds(T,e,!0);const r=new M$2({xmin:T[0],ymin:T[1],xmax:T[2],ymax:T[3],spatialReference:this.view.spatialReference});return s.queryElements(r,t$1)}_acquireElements(e,t$1){const s=this.layer.source,i=this.view.spatialReference;if(!t(s))for(const o of t$1){r$5(this._elementReferences,o.uid,(()=>{const e=new a$3({element:o,spatialReference:i}),t=new _(e);return this._overlayContainer.addChild(t),this.elements.add(o),{tiles:new Set,projectedElement:e,overlay:t}})).tiles.add(e);}}_releaseElements(e,t){for(const s of t){const t=this._elementReferences.get(s.uid);t.tiles.delete(e),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s));}}};e$2([d()],w.prototype,"_fetchQueue",void 0),e$2([d()],w.prototype,"layer",void 0),e$2([d({readOnly:!0})],w.prototype,"elements",void 0),w=e$2([n$1("esri.views.2d.layers.MediaLayerView2D")],w);const T=u$2();class R{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0;}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const r of e)s.has(r)?s.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(s)]}}const S=w;

export default S;
