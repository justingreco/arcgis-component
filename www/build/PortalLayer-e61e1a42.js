import { s, X as f, J as g, $ as w$1, t, r, a as s$1, e, d, n as n$1 } from './cast-3d5be210.js';
import { a as n, F, U, N } from './request-ac4d8bfb.js';
import { a } from './asyncUtils-96c00c9e.js';
import { o, r as r$1 } from './Point-edff2a11.js';
import { B, p } from './Portal-5df9f5a7.js';
import b from './PortalItem-fa114dd2.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const w=s.getLogger("esri.layers.mixins.PortalLayer"),v=i=>{let v=class extends i{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0;}destroy(){this.portalItem?.destroy(),this.portalItem=null;}set portalItem(t){t!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",t));}readPortalItem(t,r,e){if(r.itemId)return new b({id:r.itemId,portal:e&&e.portal})}writePortalItem(t,r){t&&t.id&&(r.itemId=t.id);}async loadFromPortal(t,r){if(this.portalItem&&this.portalItem.id)try{const e=await import('./layersLoader-ebf1caa7.js').then(function (n) { return n.l; });return f(r),await e.load({instance:this,supportedTypes:t.supportedTypes,validateItem:t.validateItem,supportsData:t.supportsData},r)}catch(e){throw g(e)||w.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${e}`),e}}async finishLoadEditablePortalLayer(t){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(t).catch((t=>(w$1(t),!0))));}async _fetchUserHasEditingPrivileges(t$1){const e=this.url?n?.findCredential(this.url):null;if(!e)return !0;const s=P.credential===e?P.user:await this._fetchEditingUser(t$1);return P.credential=e,P.user=s,t(s)||null==s.privileges||s.privileges.includes("features:user:edit")}async _fetchEditingUser(t){const o=this.portalItem?.portal?.user;if(o)return o;const i=n.findServerInfo(this.url);if(!i?.owningSystemUrl)return null;const a$1=`${i.owningSystemUrl}/sharing/rest`,p$1=B.getDefault();if(p$1&&p$1.loaded&&F(p$1.restUrl)===F(a$1))return p$1.user;const n$1=`${a$1}/community/self`,m=r(t)?t.signal:null,u=await a(U(n$1,{authMode:"no-prompt",query:{f:"json"},signal:m}));return u.ok?p.fromJSON(u.value.data):null}read(t,r){r&&(r.layer=this),super.read(t,r);}write(t,r){const e=r&&r.portal,s=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||B.getDefault());return e&&s&&!N(s.restUrl,e.restUrl)?(r.messages&&r.messages.push(new s$1("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(t,{...r,layer:this})}};return e([d({type:b})],v.prototype,"portalItem",null),e([o("web-document","portalItem",["itemId"])],v.prototype,"readPortalItem",null),e([r$1("web-document","portalItem",{itemId:{type:String}})],v.prototype,"writePortalItem",null),e([d({clonable:!1})],v.prototype,"resourceReferences",void 0),e([d({readOnly:!0})],v.prototype,"userHasEditingPrivileges",void 0),v=e([n$1("esri.layers.mixins.PortalLayer")],v),v},P={credential:null,user:null};

export { v };
