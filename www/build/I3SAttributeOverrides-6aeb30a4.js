import { aw as A$1, aA as n$2, J as g$1, r as r$4, t as t$2, h as e$2, U as k$1, aR as p$3, c as a$3, E as E$3, m, _ as d$1, bu as N$1, s as s$5, y as y$3, e as e$5, d as d$2, n as n$5, aF as n$7, b1 as F$2, aq as y$4, b5 as d$3, ak as m$4 } from './cast-3d5be210.js';
import { u as u$2 } from './Handles-54afc0a7.js';
import { m as m$2 } from './Promise-d2759b2e.js';
import { l, h as h$3, U } from './reactiveUtils-bd6fe823.js';
import { b as bn, z as zn } from './projection-fbd5d346.js';
import { u as u$3, g as g$2 } from './aaBoundingRect-5e1a4e52.js';
import { v } from './dehydratedFeatures-7b45465d.js';
import { L as L$1, i as i$4, w as w$3 } from './Scheduler-ed7a36dc.js';
import { o as o$4 } from './ViewingMode-4a1cffad.js';
import { s as s$3, o as o$2, ah as i$1, n as n$4, B as a$5, p as p$5, x as x$3, q, P as P$3, v as v$1, e as e$3, u as u$1 } from './mathUtils-559a53d9.js';
import { e as e$1 } from './vec4f64-011248e0.js';
import { n as n$1, a as a$1, t as t$1, h as h$1, i, o, d, c, s as s$6 } from './I3SNode-418da2f2.js';
import { a7 as Le, a1 as F$1, ae as ft, af as lt, ag as a$2, Z as E$4, ah as h$2, ai as o$3, i as i$3, Q as ct, aj as m$1, N as st, ak as Be, al as Pe, am as O$2, a5 as me, a6 as he, an as A$2, ao as Re, K as ve, p as e$4, ap as se, aq as I$3 } from './SceneView-ed3703c9.js';
import { a as a$4, i as i$2, u as u$4 } from './asyncUtils-96c00c9e.js';
import { Q as Q$1, U as U$1 } from './request-ac4d8bfb.js';
import { I as I$2, w as w$2 } from './I3SBinaryReader-1f7e5bc9.js';
import { bx as u, T as L$2, a0 as o$1 } from './objectResourceUtils-e575a410.js';
import { n as n$3, C as C$3 } from './OrderIndependentTransparency-b8c8f539.js';
import { D as D$2 } from './enums-4770f29d.js';
import { p as p$4, O as O$3 } from './unitUtils-a0a11e54.js';
import { H as H$1, s as s$4, m as P$2 } from './frustum-95850b85.js';
import { T as T$2 } from './Point-edff2a11.js';
import { C as C$4 } from './sphere-4710475c.js';
import { r as r$5, c as c$1 } from './GoTo-929e809f.js';
import { n as n$6 } from './Collection-a38e0489.js';
import { n as n$8, t as t$4 } from './byteSizeEstimations-5d50d6ff.js';
import { m as m$3 } from './number-c5a37d3e.js';
import { a as a$6, t as t$3 } from './featureQueryAll-cad40ef9.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class r$3{constructor(t){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(L$1.I3S_CONTROLLER,this);}destroy(){this.handle&&(this.handle.remove(),this.handle=null);}get running(){for(const t of this.callbacks)if(t.needsUpdate())return !0;return !1}runTask(t){this._sort();const e=this.callbacks,r={numIndexLoading:0,numNodesLoading:0};for(let s=0;s<e.length&&!t.done;++s)e[s].priority=e[s].update(t,r),this.runIndex=s;}_sort(){const t=this.callbacks;let e=t.length;for(let r=this.runIndex;r>0;r--){const s=t[r-1];let n=r;for(;n<t.length&&s.priority<=t[n].priority&&(n!==e||s.priority<t[n].priority);)t[n-1]=t[n],n++;t[n-1]=s,e=n-1;}this.runIndex=0;}add(t){this._sort(),t.priority=1/0,this.callbacks.unshift(t);}remove(e){A$1(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort();}}const s$2=new Map;function n(t,e){let n=s$2.get(t);return null==n&&(n=new r$3(t),s$2.set(t,n)),n.add(e),{remove:()=>{if(null==n)return;n.remove(e);n.callbacks.length>0||(s$2.delete(t),n.destroy()),n=null;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class b$2{constructor(e,t,i,s,n){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=n,this.useAsHole=0,this.filterImpact=n$1.NotChecked;}}class p$2{constructor(e,t,i,n,r,o,d,l,h,u,c,g,m,_){this.streamDataController=i,this.viewportQueries=n,this.logger=r,this.holeFilling=o,this._isLoaded=d,this._isReloading=l,this._isSelected=h,this._enable=u,this._needsUpdate=c,this._canRequest=g,this._computeVisibilityObb=m,this._computeNodeFiltering=_,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=a$1.None,this._lodConversion=e=>e,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=I$1(0),this._visibilityCacheVersion=I$1(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n$2({deallocator:null}),this._prefetch=new n$2({deallocator:null}),this._updates=new N(this._missing),this._imModificationUncategorized=new n$2({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this._init(t);}_init(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=a$1.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this.lodMetric=a$1.MaxScreenThreshold,this._lodConversion=V;}this._addPage(S$1(this.rootIndex,this.nodesPerPage),e.rootPage),this._updateParentsAndLevel();}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new t$1(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0);}}_loadPage(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t});})).catch((t=>{this._loading.delete(e),g$1(t)||(this._failedPages.add(e),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${e}`,t));}));}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loading.delete(t),e.madeProgress();}this._updateParentsAndLevel();}_addPage(e,t){for(let r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;const i=[],s=[],n=t.nodes.map(((t,n)=>{const a=i.length,d=t.children?t.children.length:0;s.push(-1);for(let e=0;e<d;e++)i.push(t.children[e]);const h=`${t.index}`,u=F$1(t.obb),c=e$1([u.center[0],u.center[1],u.center[2],s$3(u.halfSize)]),g=t.mesh&&t.mesh.attribute,m=t.mesh&&t.mesh.geometry,_=t.mesh&&t.mesh.material,f={hasSharedResource:!1,hasFeatureData:!!m,attributes:g&&null!=g.resource?`${g.resource}`:null,geometry:m&&null!=m.resource?`${m.resource}`:null,texture:_&&null!=_.resource?`${_.resource}`:null,geometryDefinition:m?m.definition:-1,materialDefinition:_?_.definition:-1},p=new h$1(h,e*this.nodesPerPage+n,c,d,0,f,this.lastUpdate,this.lodMetric,this._lodConversion(t.lodThreshold),m?m.featureCount:null);return p.serviceObb=u,p.visibilityObb=this._computeVisibilityObb(p),p.vertexCount=m?m.vertexCount:0,new b$2(a,d,x$2(this._visibilityCacheVersion),null,p)}));this._nodePages[e]={nodes:n,children:i,parents:s},this.nodeCount+=n.length;}_updateParentsAndLevel(){const t=new Array,i=(i,s,n)=>{const r=this._getPage(i);if(r$4(r)){const o=L(i,this.nodesPerPage);r.parents[o]=s;const a=r.nodes[o].node;r$4(a)&&(a.level=n,t.push(i));}};for(i(this.rootIndex,-1,0);t.length;){const s=t.pop(),n=this.getNode(s);if(r$4(n))for(let e=0;e<n.childCount;e++){i(this.getChildIndex(n.index,e),s,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1);}}}_getPage(e){return this._nodePages[S$1(e,this.nodesPerPage)]}_getNodeInternal(e){const i=this._getPage(e);return t$2(i)?null:i.nodes[L(e,this.nodesPerPage)]}_addNode(t,s){null!=t.children&&this.populateChildren(s,t.children);const n=this.getParent(s),r=r$4(n)?n.level+1:0;this._maxLevel=Math.max(this._maxLevel,t.children?r+1:r);const{lodMetric:a,maxError:d}=E$2(t.lodSelection),h=e$2(this._getNodeInternal(s));return h.node=new h$1(t.id,s,e$1(t.mbs),h.childCount,r,t.resources,t.version,a,d,t.numFeatures),t.obb&&(h.node.serviceObb=F$1(t.obb)),h.node.visibilityObb=this._computeVisibilityObb(h.node),r$4(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=t.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb),h.node}_makeRefNode(e,t){const i=this._nodePages[0],s=i.nodes.length;return i.nodes.push(new b$2(0,0,x$2(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),ft(e.renderMbs),lt(e.serviceObbInRenderSR),s}populateChildren(e,t){const s=e$2(this._getNodeInternal(e)),n=e$2(this._getPage(e));s.childOffset=n.children.length,s.childCount=t.length;for(let i=0;i<t.length;i++){const s=this._makeRefNode(t[i],e);n.children.push(s);}}getNode(t){const i=this._getNodeInternal(t);return r$4(i)?i.node:null}getIndexById(t){let i;return this._forAllNodes(((s,n)=>{(r$4(s.node)&&s.node.id===t||r$4(s.ref)&&s.ref.id===t)&&(i=n);})),i}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,i){const s=this._getPage(e);if(t$2(s))return -1;const n=s.nodes[L(e,this.nodesPerPage)];return s.children[n.childOffset+i]}getParentIndex(t){const i=this._getPage(t);return r$4(i)?i.parents[L(t,this.nodesPerPage)]:-1}getParent(e){return (e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(t){const i=this._getNodeInternal(t);return r$4(i)&&0===i.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}removeAllGeometryObbs(){this._forAllNodes((t=>{r$4(t.node)&&(t.node.geometryObb=null);}));}invalidateVisibilityCache(){this._visibilityCacheVersion=I$1(this._visibilityCacheVersion);}invalidateNodeVisibilityCache(t){const i=this._getNodeInternal(t);r$4(i)&&this.invalidateNodeVisibilityCacheInternal(i);}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=x$2(this._visibilityCacheVersion);}invalidateBoundingVolumeCache(t){const i=this._getNodeInternal(t);r$4(i)&&(P$1(i),this.invalidateNodeVisibilityCacheInternal(i));}updateElevationChanged(i){const s=this._getNodeInternal(i);if(t$2(s))return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(i);const n=r$4(s.node)?s.node:s.ref;if(t$2(n))return;const r=n.elevationRange;t$2(r)||(r.valid=!1);}invalidateGeometryVisibility(t){const i=this._getNodeInternal(t);r$4(i)&&r$4(i.node)&&(i.node.geometryObb=null,ft(i.node.renderMbs),lt(i.node.serviceObbInRenderSR));}invalidateVisibilityObbs(){t$2(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)));}_updateElevationRange(i$1){const s=this._getNodeInternal(i$1);if(t$2(s))return null;const n=r$4(s.node)?s.node:s.ref;if(t$2(n))return null;const r=n.elevationRange;if(r$4(r)&&r.valid)return r;const o=new i;let a=!1;for(let e=0;e<s.childCount;e++){const s=this._updateElevationRange(this.getChildIndex(i$1,e));t$2(s)?a=!0:(o.min=Math.min(o.min,s.min),o.max=Math.max(o.max,s.max));}if(0===s.childCount||a&&r$4(s.node)&&s.node.resources.geometry){const t=this.viewportQueries.getElevationRange(n);r$4(t)&&(o.min=Math.min(o.min,t.min),o.max=Math.max(o.max,t.max));}return r$4(r)&&r.min===o.min&&r.max===o.max?(r.valid=!0,r):(o.valid=!0,n.elevationRange=o,this.invalidateBoundingVolumeCache(i$1),o)}isNodeVisible(i){const s=this._getNodeInternal(i);if(t$2(s)||r$4(s.ref)&&!s.ref.mbs)return !0;if(this.needNodeElevationRange&&this._updateElevationRange(i),!w$1(s.visibilityCache,this._visibilityCacheVersion)){const i=s.node,n=r$4(i)&&(t$2(s.ref)||r$4(i.visibilityObb))?i:r$4(s.ref)?s.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(r$4(i)||r$4(s.ref))&&s.filterImpact===n$1.NotChecked){const t=r$4(i)?i.mbs:r$4(s.ref)?s.ref.mbs:null;s.filterImpact=null!=t?this._computeNodeFiltering(t):n$1.Unmodified;}const r=r$4(i)&&s.filterImpact===n$1.Culled,o$1=!(r$4(i)&&i.imModificationImpact===o.Culled)&&(!n||this.viewportQueries.isNodeVisible(n))&&!r;return s.visibilityCache=C$2(o$1,this._visibilityCacheVersion),o$1}return M$1(s.visibilityCache)}isGeometryVisible(t){if(!this.isNodeVisible(t))return !1;const i=this._getNodeInternal(t);return !(r$4(i)&&r$4(i.node)&&r$4(i.node.geometryObb)&&(!this.layerHasModifications||i.node.imModificationImpact!==o.NotChecked))||this.viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(s,n,r,o,a){const d=this._getPage(s);if(t$2(d)||0===n.childCount)return;const l=n.childOffset+n.childCount,h=new Array;for(let t=n.childOffset;t<l;++t){const i=d.children[t],s=this._getNodeInternal(i);r$4(s)&&r$4(s.node)&&this.isGeometryVisible(i)&&h.push(s);}o/=h.length;for(const e of h){const t=e$2(e.node).index;this._isLoaded(t)||this._isReloading(t)?(a.delta=Math.max(a.delta,r),a.coverage+=o):this._traverseCoverage(t,e,r+1,o,a);}}useNodeAsHole(e){if("off"===this.holeFilling)return !1;const i=this._getNodeInternal(e);if(t$2(i))return !1;if("always"===this.holeFilling)return !0;if(w$1(i.useAsHole,this._version))return M$1(i.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,i,0,1,s);const n=s.delta*s.coverage<=.5;return i.useAsHole=C$2(n,this._version),n}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune();}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=I$1(this._version);}imModificationsChanged(t){this.layerHasModifications=t,this._forAllNodes((({node:t})=>{r$4(t)&&(t.imModificationImpact=o.NotChecked,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index));})),this.invalidateVisibilityCache();}layerFilterChanged(t){this._layerHasFilter=t,this._forAllNodes((t=>{if(r$4(t)){t.filterImpact=n$1.NotChecked;const i=t.node;r$4(i)&&this.invalidateNodeVisibilityCache(i.index);}})),this.invalidateVisibilityCache();}update(s,n,r){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(n),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(s),y$2.clear();let o$1=!0;const a=new O$1,d=new O$1,l=this._imModificationUncategorized;l.clear();const h=new Set,u=(u,g,m)=>{if(t$2(g)){let e=this._entryPriority(u);e===1/0&&(e=this._entryPriority(m));const t=S$1(u,this.nodesPerPage);return y$2.set(t,Math.max(e,y$2.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const _=g.node;if(this._updateNodeFeatureEstimate(_,d),t$2(_)){const e=this._entryPriority(u);return this._loading.has(u)||this._failedNodes.has(u)||(this._missing.push(u),y$2.set(u,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=e$2(this._getPage(u));if(0===this._missing.length&&0===this.nodesPerPage)for(let t=0;t<g.childCount;t++){const i=f.children[g.childOffset+t],s=this._getNodeInternal(i);!r$4(s)||s.node||this._loading.has(i)||this._failedNodes.has(i)||(y$2.set(i,this._entryPriority(i)),this._prefetch.push(i));}if(_.failed||!_.resources.hasFeatureData)return void(o$1&&g.childCount>0&&this._isSelected(_)&&(o$1=!1));if(h.add(_.id),this._isLoaded(u)){if(a.known+=_.memory,++a.knownNodes,this._isSelected(_)?g.childCount>0&&(o$1=!1):(a.unremoved+=_.memory,o$1=!1),this._needsUpdate(_)){const e=this._entryPriority(u);y$2.set(u,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(u);}return}if(_.memory&&(a.known+=_.memory,++a.knownNodes),!this._isSelected(_))return void(this._isReloading(u)&&this._updates.remove.push(u));if(g.childCount>0&&(o$1=!1),_.memory?(a.missing+=_.memory,a.known+=_.memory,++a.knownNodes):++a.missingNodes,s.includes(_.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(u)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==_.index)));if(!n.done&&this._enable(_))return void n.madeProgress();const v=this._entryPriority(u);y$2.set(u,v),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,v),this._updates.add.push(u),this.layerHasModifications&&r&&r$4(_)&&_.imModificationImpact===o.NotChecked&&l.push(u);};this.traverseVisible(u);const g=this._updates.add;g.length>0&&this.layerHasModifications&&(l.length>0&&r(l),g.filterInPlace((e=>{const i=this._getNodeInternal(e),s=t$2(i)||t$2(i.node)||i.node.imModificationImpact!==o.Culled;return s||this.invalidateNodeVisibilityCache(e),s}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=o$1,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>y$2.get(e)-y$2.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=y$2.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>y$2.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>y$2.get(e)-y$2.get(t))),this._updates.update.sort(((e,t)=>y$2.get(e)-y$2.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,y$2.clear();}checkFeatureTarget(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let s=t,n=t,r=i,o=10;for(;o--;){const i=new O$1;this._updateFeatureEstimate(s,i);if(this._computeFeatureEstimate(i)<=e){if(s>=t||i.missingNodes>0||0===o)break;r=s,s=.5*(s+n);}else n=s,s=.5*(s+r);}return this._version=I$1(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)}_updateFeatureEstimate(t,i){this._version=I$1(this._version),this.viewportQueries.updateScreenSpaceErrorBias(t),this.traverseVisible(((t,s)=>this._updateNodeFeatureEstimate(r$4(s)&&s.node,i)));}_updateNodeFeatureEstimate(i,s){if(!(t$2(i)||i.failed||t$2(i.numFeatures)))return this._isLoaded(i.index)?(s.known+=i.numFeatures,++s.knownNodes,void(this._isSelected(i)||(s.unremoved+=i.numFeatures))):void(this._isSelected(i)&&(r$4(i.numFeatures)?(s.missing+=i.numFeatures,s.known+=i.numFeatures,++s.knownNodes):++s.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort(((e,t)=>y$2.get(e)-y$2.get(t))),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return !1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return !0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(e){if(t$2(e))return null;let i=this._nodeTraversalState.get(e.index);if(i&&w$1(i.version,this._version))return i;const s=this.viewportQueries.getLodLevel(e),n=this.viewportQueries.hasLOD(e);let r=!0;if(n){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);r=e&&s>e.lodLevel;}else r=s>0;}else r=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=r,i.version=C$2(!0,this._version),i):(i=new d(n,r,s,C$2(!0,this._version)),this._nodeTraversalState.set(e.index,i),i)}_loadNode(e){this._loading.add(e);const s=e$2(this._getNodeInternal(e)).ref;if(t$2(s))return void this._failedNodes.add(e);const r=s.id,o=this.urlPrefix+r,a=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate();};this.streamDataController.request(o,"json").then((t=>{a();const i=this._validateNode(r,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const s=this._addNode(i,e);this.nodeTraversalState(s);}),(t=>{a(),g$1(t)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+o),this._failedNodes.add(e));}));}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,n=t=>{if(null==t)return null;const i=t=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${e}"`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=new t$1(`${t.id}`,t.mbs);return n.serviceObb=s,n.visibilityObb=this._computeVisibilityObb(n),n},r=Array.isArray(t.children)?t.children.map(n).filter((e=>null!=e)):null;return {id:e,mbs:t.mbs,obb:i,children:r,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:s}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((t=>{r$4(t.node)&&(t.node.failed=!1);}));}_entryPriority(i){const s=this._getNodeInternal(i),n=this.getParentIndex(i);if(t$2(s)||n<0&&null==s.node)return n<0?1/0:this._entryPriority(n);let r=0;if(s.node&&n>=0){const e=this._nodeTraversalState.get(n);null!=e&&(r=e.lodLevel);}let o=this.progressiveLoadPenalty;for(let e=i;e>=0;e=this.getParentIndex(e))if(this._isLoaded(e)){o=0;break}const a=r$4(s.ref)?this.viewportQueries.distToPOI(s.ref):r$4(s.node)?this.viewportQueries.distToPOI(s.node):0;return -a-r*(a+this.progressiveLoadPenalty)+o}traverseVisible(e){const i=this._getNodeInternal(this.rootIndex);t$2(i)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,i,e);}_traverseVisible(t,s,n,r){if(n.node&&0===n.childCount)return void(this.isGeometryVisible(t)&&r(t,n,s));if(!this.isNodeVisible(t))return;if(r(t,n,s),null==n.node)return;const o=this.nodeTraversalState(n.node);if(o.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=e$2(this._getPage(t));for(let i=0;i<n.childCount;i++){const s=a.children[n.childOffset+i],o=this._getNodeInternal(s);r$4(o)?this._traverseVisible(s,t,o,r):r(s,null,t);}}traverse(e,t){t(e)&&this.traverseChildren(e,t);}traverseChildren(t,i){const s=t.index,n=this._getNodeInternal(s);r$4(n)&&this._traverseChildren(s,n,i);}_traverseChildren(i,s,n){const r=this._getPage(i);if(t$2(r))return;const o=s.childOffset+s.childCount;for(let t=s.childOffset;t<o;++t){const i=r.children[t],s=this._getNodeInternal(i);r$4(s)&&r$4(s.node)&&n(s.node)&&this._traverseChildren(i,s,n);}}updateChildrenLoaded(t,i){let s=this.getNode(t);for(;r$4(s);)s.childrenLoaded+=i,s=this.getParent(s.index);}checkChildrenLoadedInvariant(){if(t$2(this.rootNode))return !0;const e=[],i=t=>{let s=this._isLoaded(t.index)||this._isReloading(t.index)?1:0;return this.traverseChildren(t,(e=>(s+=i(e),!1))),t.childrenLoaded!==s&&e.push(t.index),s};return i(this.rootNode),e.length&&this.logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t);}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(t,i){this.needNodeElevationRange=i&&t&&("relative-to-ground"===t.mode||"on-the-ground"===t.mode),this._forAllNodes((t=>{P$1(t),r$4(t.node)&&(t.node.elevationRange=null),r$4(t.ref)&&(t.ref.elevationRange=null);})),this.viewportQueries.updateElevationInfo(t);}_forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const s=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],s+t);}}}get test(){return {addNode:(e,t)=>this._addNode(e,t)}}}const y$2=new Map;class N{constructor(e){this.missing=e,this.update=new n$2({deallocator:null}),this.add=new n$2({deallocator:null}),this.remove=new n$2({deallocator:null}),this.cancel=[];}reset(e){this.add.clear(),this.update.clear(),this.cancel=e;}}function P$1(t){r$4(t.node)&&(ft(t.node.renderMbs),lt(t.node.serviceObbInRenderSR)),r$4(t.ref)&&(ft(t.ref.renderMbs),lt(t.ref.serviceObbInRenderSR));}function x$2(e){return Le(e,-2)}function I$1(e){return Le(e,2)}function C$2(e,t){return t+(e?1:0)}function w$1(e,t){return (-2&e)===t}function M$1(e){return 1==(1&e)}function S$1(e,t){return 0===t?0:e/t|0}function L(e,t){return 0===t?e:e%t}const R$2=[["maxScreenThreshold",a$1.MaxScreenThreshold],["screenSpaceRelative",a$1.ScreenSpaceRelative],["removedFeatureDiameter",a$1.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",a$1.DistanceRangeFromDefaultCamera]];function E$2(e){if(e)for(let t=0;t<e.length;t++)for(const i of R$2)if(i[0]===e[t].metricType)return {lodMetric:i[1],maxError:e[t].maxError};return {lodMetric:a$1.None,maxError:0}}class O$1{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0;}}function V(e){return Math.sqrt(e*(4/Math.PI))}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var a;!function(a){a[a.FadeIn=0]="FadeIn",a[a.FadeOut=1]="FadeOut";}(a||(a={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class t{constructor(e){this.layerView=e,this._lodGlobalDirty=!1;}startNodeLoading(e,i,o,s){this._maxLodLevel=s.maxLodLevel,this._index=o,this._isNodeInScaleBounds=e,this._removeNodes=i;}shouldLoadNode(i){if(t$2(i))return !1;const o=this._index.nodeTraversalState(i);return !!this._isChosenMaxLOD(o)||!!o.isChosen&&this._childrenRequireLoading(i)}setLodGlobalDirty(){this._lodGlobalDirty=!0;}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return !1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,o=Math.max(0,Math.floor(10*(i-1)));r$2.clear(),this._lodGlobalHandling(this._index.rootNode,o,!1,this.layerView.nodeCrossfadingEnabled);const s=r$2.length;this._removeNodes(r$2,e);const d=r$2.length<s;return 0!==r$2.length&&(this._lodGlobalDirty=!0),r$2.clear(),d}_lodGlobalHandling(o,t,l,n){if(t$2(o))return !1;const a$1=o.index,h=this._index,u=this.layerView,c$1=h.nodeTraversalState(o),_=this._isChosenMaxLOD(c$1),x=!o.resources.hasFeatureData;if(_&&x)return o.childrenLoaded>0&&this._removeChildrenRecursive(o),!0;const L=u.isNodeLoaded(a$1);if(n&&L&&_){const e=!l&&this.hasNoVisibleChildren(o);u.fadeNode(a$1,a.FadeIn,!e);}const N=L&&(!u.isNodeFullyFadedIn||u.isNodeFullyFadedIn(a$1));if(L&&(u.updateNodeState(a$1,_?c.Leaf:c.Hole),_))return N&&this._removeChildrenRecursive(o),N;const m=o.childCount>0;let y=m;if(m)for(let e=0;e<o.childCount;e++){const o=h.getChildIndex(a$1,e),s=h.getNode(o);if(r$4(s)){!(!h.isGeometryVisible(o)||this._lodGlobalHandling(s,t,l||N,n))&&this._isNodeInScaleBounds(s)&&(y=!1);}else h.isNodeVisible(o)&&(y=!1);}const b=L&&!_&&(y||r$2.length<t);b&&r$2.push(a$1),!n||b||!L||l||y||u.fadeNode(a$1,a.FadeIn,!1);const f=!o.resources.hasFeatureData;return y||N&&!b||f}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&r$2.push(e.index),e.childrenLoaded>0)));}hasNoVisibleChildren(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(this.layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0))),i}_childrenRequireLoading(e){let i=!1,o=!0;return this._index.traverseChildren(e,(e=>{if(!o||!this._index.isNodeVisible(e.index))return !1;const s=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(i=!0),this.layerView.isNodeLoaded(e.index)?(o=!1,!1):e.childrenLoaded>0})),o&&i}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const r$2=new n$2({deallocator:null});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
var e,s$1;!function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2";}(e||(e={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR";}(s$1||(s$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class r$1{constructor(t,r){this._textureRep=t,this._disposed=!1;const i=this._textureRep.acquire(r);k$1(i)?(i.then((t=>{this._disposed?p$3(t):this._textureRef=t;})),this.loadPromise=i):this._textureRef=i;}dispose(){this._textureRef=p$3(this._textureRef),this._disposed=!0;}get glTexture(){return r$4(this._textureRef)?this._textureRef.glTexture:null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
function h(e,a){const o=new Map,t=(e,a)=>{if(t$2(e))return -1;if(o.has(e.id)){const r=o.get(e.id);return r.usage|=a,r.id}const r=o.size;return o.set(e.id,{id:r,usage:a}),r},l=a.pbrMetallicRoughness,u$1=l&&l.baseColorFactor,c=a.emissiveFactor,d=null==a.normalTexture&&null==a.emissiveTexture&&null==a.occlusionTexture&&(!l||null==l.metallicRoughnessTexture&&1===l.roughnessFactor&&(1===l.metallicFactor||0===l.metallicFactor)),g=d?u[0]:l?l.metallicFactor:1,p=d?u[1]:l?l.roughnessFactor:1,h="mask"===a.alphaMode?s$1.Color|s$1.AlphaMask:s$1.Color,x={baseColorFactor:u$1?[u$1[0],u$1[1],u$1[2],u$1[3]]:[1,1,1,1],baseColorTextureId:t(l&&l.baseColorTexture,h),metallicRoughnessTextureId:t(l&&l.metallicRoughnessTexture,s$1.MetallicRoughness),metallicFactor:g,roughnessFactor:p},b={alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,cullFace:"none"===a.cullFace?n$3.None:"back"===a.cullFace?n$3.Back:"front"===a.cullFace?n$3.Front:void 0,normalTextureId:t(a.normalTexture,s$1.Normal),emissiveTextureId:t(a.emissiveTexture,s$1.Emissive),occlusionTextureId:t(a.occlusionTexture,s$1.Occlusion),emissiveFactor:c?[c[0],c[1],c[2]]:[0,0,0],metallicRoughness:x,wrapTextures:!1,hasParametersFromSource:d},F=[];return o.forEach((({usage:a},o)=>{const s=r$4(e)&&e[o]&&e[o].formats,t=s?f$1(s.map((({name:e,format:a})=>({name:e,encoding:T$1[a]})))):[];F.push({id:o,usage:a,encodings:t});})),{material:b,textures:F}}function f$1(e){return e.sort(((e,a)=>e.encoding-a.encoding))}const T$1={ktx2:e.KTX2,basis:e.Basis,dds:e.DDS_S3TC,png:e.PNG,jpg:e.JPG,"ktx-etc2":e.KTX_ETC2},x$1={[L$2.KTX2_ENCODING]:e.Basis,[L$2.BASIS_ENCODING]:e.Basis,[L$2.DDS_ENCODING]:e.DDS_S3TC,"image/png":e.PNG,"image/jpg":e.JPG,"image/jpeg":e.JPG,"image/ktx":e.KTX_ETC2};function b$1(e){const o=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,s=o&&e.materialDefinitions[o],t=r&&e.textureDefinitions[r],l=F();if(null!=s){const e=s.params;e.diffuse&&(l.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(l.doubleSided=e.doubleSided,l.cullFace=e.doubleSided?n$3.None:n$3.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(l.cullFace="none"===e.cullFace?n$3.None:"back"===e.cullFace?n$3.Back:n$3.Front),e.transparency&&(l.metallicRoughness.baseColorFactor[3]=o$2(1-e.transparency,0,1)),(e.useVertexColorAlpha||l.metallicRoughness.baseColorFactor[3]<1)&&(l.alphaMode="blend");}const i=[];if(null!=t){const e=0;!t.wrap||"repeat"!==t.wrap[0]&&"repeat"!==t.wrap[1]||(l.wrapTextures=!0);let a=s$1.Color;"rgba"===t.channels&&(l.alphaMode="blend",a|=s$1.AlphaMask);const o=t.images.length-1,r=t.images[o],s=e=>e&&e.split("/").pop(),u=Array.isArray(t.encoding)?f$1(t.encoding.map(((e,a)=>({name:s(r.href[a]),encoding:x$1[e]||0})))):[{name:s(r.href),encoding:x$1[t.encoding]||0}];i.push({id:e,usage:a,encodings:u}),l.metallicRoughness.baseColorTextureId=e;}return {material:l,textures:i}}const F=()=>({alphaMode:"opaque",alphaCutoff:o$1,doubleSided:!0,cullFace:n$3.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function C$1(e,a,r,t){if(t$2(e)||null==e.data)return null;const l=e.data,i=!(l instanceof HTMLImageElement)||i$1(l.width)&&i$1(l.height),u=t.renderingContext.parameters.maxMaxAnisotropy,c=r&&!t.capabilities.shaderTextureLOD?1:u,m=i&&!e.downsampled&&c>1,d=r||!a.wrapTextures?P:M,p=E$1(e.encoding),h=e.usage&s$1.Color?"opaque"===a.alphaMode?3:4:3;return new L$2(l,{mipmap:m,maxAnisotropy:c,encoding:p,wrap:d,components:h,noUnpackFlip:!0})}const P={s:D$2.CLAMP_TO_EDGE,t:D$2.CLAMP_TO_EDGE},M={s:D$2.REPEAT,t:D$2.REPEAT};function S(e,o,s,t,i,m){const g=m.rendererTextureUsage,p=e=>R$1(t,s,e&g),h=o.metallicRoughness.baseColorFactor,f=o$2(o.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[h[0],h[1],h[2],f],e.hasParametersFromSource=!!o.hasParametersFromSource,e.usePBR=m.usePBR,e.mrrFactors=[o.metallicRoughness.metallicFactor,o.metallicRoughness.roughnessFactor,o.hasParametersFromSource?.2:.5],e.emissiveFactor=o.emissiveFactor,e.isIntegratedMesh=m.isIntegratedMesh,e.textureAlphaCutoff="mask"===o.alphaMode?o.alphaCutoff:o$1,e.alphaDiscardMode="opaque"===o.alphaMode?C$3.Opaque:"mask"===o.alphaMode?C$3.Mask:C$3.MaskBlend;const T=[],x=p(s$1.Color|s$1.AlphaMask);r$4(x)&&(e.baseColorTexture=new r$1(i,x),T.push(e.baseColorTexture.loadPromise));const b=p(s$1.MetallicRoughness);r$4(b)&&(e.metallicRoughnessTexture=new r$1(i,b),T.push(e.metallicRoughnessTexture.loadPromise));const F=p(s$1.Emissive);r$4(F)&&(e.emissionTexture=new r$1(i,F),T.push(e.emissionTexture.loadPromise));const C=p(s$1.Occlusion);r$4(C)&&(e.occlusionTexture=new r$1(i,C),T.push(e.occlusionTexture.loadPromise));const P=p(s$1.Normal);return r$4(P)&&(e.normalTexture=new r$1(i,P),T.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=m.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=o.doubleSided,e.commonMaterialParameters.cullFace=o.cullFace,e.ellipsoidMode=a$2(m.viewSpatialReference),Promise.all(T)}function D$1(a){const o=!!a.compressedTextureS3TC,r=!!a.compressedTextureETC,s=a$3("disable-feature:i3s-basis")?0:e.Basis|e.KTX2,n=e.JPG|e.PNG,l=s|e.DDS_S3TC;return n|(o?l:0)|(r?s:0)}function w(e,a){return e.find((e=>0!=(e.encoding&a)))}function R$1(e,a,o){if(t$2(e)||o===s$1.None)return null;for(let s=0;s<e.length;s++){const t=e[s];if(r$4(t)&&0!=(t.usage&o)){const e=a[s];return r$4(e)?e.id:null}}return null}function E$1(e$1){switch(e$1){case e.KTX2:return L$2.KTX2_ENCODING;case e.Basis:return L$2.BASIS_ENCODING;case e.DDS_S3TC:return L$2.DDS_ENCODING;case e.PNG:return "image/png";case e.JPG:return "image/jpeg";case e.KTX_ETC2:return "image/ktx";default:return ""}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class g{constructor(e,t,r,i,o,n){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=o,this.options=n,this.logLayer=e,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((e=>h(t,e)));}}_load(e,t,r){return this.streamDataController.request(e,t,r)}_loadAttribute(e,t,r){const i=`${this.layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(i,"binary",r).then((e=>I$2(t,e)))}loadAttributes(e,t,r){return E$3(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,r)))).then((r=>{const i={};for(let o=0;o<t.length;++o)if(r[o].value)i[t[o].name]=r[o].value;else {if(g$1(r[o].error))throw r[o].error;this.logger.error("#loadAttributes",this.logLayer,`Failed to load attributeData for '${t[o].name}' on node '${e.id}'`,r[o].error);}return i}))}async loadNodeData(r,i){const s=null!=this.requiredAttributes&&r.resources.attributes?a$4(this.loadAttributes(r,this.requiredAttributes,i)):null,{bufferDefinition:a,bufferIndex:u}=x(this.geometryDefinitions,r),l=!!r.resources.geometry,f=l?a$4(this._loadGeometry(r.resources.geometry,u,i)):null,c=r.resources.hasSharedResource?await this._loadShared(r,i):null,h=this.materialAndTextures&&r.resources.materialDefinition>=0?this.materialAndTextures[r.resources.materialDefinition]:null!=c?b$1(c):null,g=h&&h.material,A=h&&h.textures,_=`${r.id}`,w=!l&&this.options.loadFeatureData,T=w?await this._loadFeatureData(_,i):null,$=w?b(T):y$1(g),j=t$2($)&&D(T),I=null!=A&&A.length>0?a$4(this.loadTextures(r,A,i)):null;let U=null,S=null;if(f){U=i$2(await f);const e=p$1(this.defaultGeometrySchema,c);S=w$2(a,e);}const q=I?i$2(await I):null,v=s?i$2(await s):{},B=v?{attributeData:v,loadedAttributes:this.requiredAttributes}:null;if(r$4($))return {geometryData:$,attributeDataInfo:B,geometryBuffer:U,geometryDescriptor:S,requiredTextures:A,textureData:q};if(r$4(j))return {pointData:j,attributeDataInfo:B,geometryBuffer:U,geometryDescriptor:S,requiredTextures:A,textureData:q};throw new Error}static _addAbsoluteHrefTexture(e,t){const r=e.textureDefinitions;if(null!=r)for(const i of Object.keys(r))for(const e of r[i].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>Q$1(e,t))):e.hrefConcat=Q$1(e.href,t);}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const r in t){const e=t[r];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const r=e.encoding[t];"data:"===r.substring(0,5)&&(e.encoding[t]=r.substring(5));}else {const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5));}}}_loadShared(e,t){const r=`${this.layerUrl}/nodes/${e.resources.geometry}/shared`;return this._load(r,"json",t).then((e=>(g._fixTextureEncodings(e),g._addAbsoluteHrefTexture(e,r),e)))}_loadTexture(e$1,t,r,i,o,n){let s=!1;return o===e.DDS_S3TC||o===e.KTX2||o===e.Basis?this._load(e$1,"binary",n).then((e=>({id:t,usage:r,data:e,encoding:o,downsampled:s}))):this._load(e$1,"image",n).then((e=>{let n=e;const a=4096,u=2;if(i&&e.width*e.height>=a){const t=Math.ceil(e.width/u),r=Math.ceil(e.height/u),i=document.createElement("canvas");i.width=t,i.height=r;i.getContext("2d").drawImage(e,0,0,t,r),n=i,s=!0;}return {id:t,usage:r,data:n,encoding:o,downsampled:s}}))}loadTextures(e,t,r){const i=this.options.uncompressedTextureDownsamplingEnabled,o=this.options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&o))return null;const n=w(t.encodings,this.options.textureEncodings);if(null==n)return this.logger.error("#loadTextures",this.logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const s=e.resources.texture||e.id,a=`${this.layerUrl}/nodes/${s}/textures/${n.name}`;return this._loadTexture(a,t.id,t.usage,i,n.encoding,r)})))}_loadFeatureData(e,t){const r=`${this.layerUrl}/nodes/${e}/features/0`;return this._load(r,"json",t)}_loadGeometry(e,t,r){const i=`${this.layerUrl}/nodes/${e}/geometries/${t}`;return this._load(i,"binary",r)}}function y$1(e){return {featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}function b(e){for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return {featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}function D(e){const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:null});return t}function p$1(e,t){if(!e||!t||!t.materialDefinitions)return e;const r=Object.keys(t.materialDefinitions)[0];return !t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=m(e)).vertexAttributes.region,e}function x(e,t){const i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;const o=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==o)return i;for(let n=0;n<o.length;n++){const e=o[n];if(null==e.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=o[n];else if("draco"===e.compressedAttributes.encoding&&!a$3("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=e,i}return i}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class r{constructor(e,t){this.requester=e,this.apiKey=t,this.activeRequests=new Set;}get busy(){return this.requester.busy}request(r,s,o){const l=new AbortController,a=d$1(o,(()=>l.abort())),n={signal:l.signal,query:{token:this.apiKey}},i=this.requester.request(r,s,n),u={response:i,abortController:l,abortHandle:a};return this.activeRequests.add(u),N$1(i,(()=>{u.abortController=null,u.abortHandle?.remove(),u.abortHandle=null,this.activeRequests.delete(u);})),i}cancelAll(){this.activeRequests.forEach((e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove();})),this.activeRequests.clear();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const I=1e5;class A{constructor(e,t,i,s,r,n,o,a,h={}){this._indexSR=e,this._renderCoordsHelper=t,this.clippingArea=r,this._elevationProvider=n,this._viewingMode=o,this._options=h,this._frustum=H$1(),this._useFrustumCulling=!1,this._poi=n$4(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=E$4(),this._tmp1=n$4(),this._tmp2=n$4(),this._tmp3=n$4(),this._tmp0=n$4(),this._screenspaceErrorBias=h.screenspaceErrorBias||1,this._progressiveLoadFactor=h.progressiveLoadFactor||1,this.updateCamera(i,s),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(a),this._tmpPoint=v(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||T$2(this.engineSR)),this._indexSREllipsoidRadius=p$4(this._indexSR).radius;}updateElevationInfo(e){null!=e?(this._elevationContext=h$2.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(o$3(i$3(e,!1)))):this._elevationContext=null;}updateCamera(e,t){this._useFrustumCulling=t,t&&s$4(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0;}setPointOfInterest(e){this._poi=e;}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this.clippingArea=e;}getElevationRange(i){if(t$2(this._elevationContext))return null;const s=i.mbs[0],r=i.mbs[1],n=i.mbs[2],o=i.mbs[3],a="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(s,r,n,o,this._indexSR,a);const h=this._elevationProvider.getElevation(s,r,n,this._indexSR,a);return r$4(h)?{min:h,max:h}:null}getRenderMbs(e){const t=e.renderMbs;return ct(t)||(a$5(t,e.mbs),this._elevationContext&&t[3]<I&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=m$1(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),bn(t,this._indexSR,t,this.engineSR)),t}getVisibilityObb(i){if(r$4(i.visibilityObb))return i.visibilityObb;const s=i.serviceObb,r=.01*this._indexSREllipsoidRadius;return t$2(s)||!st(s)||this._isECEFOBBInLocalMode&&s.halfSize.some((e=>e>r))?null:(i.serviceObbInRenderSR=this._computeRenderObb(s,i.serviceObbInRenderSR,i.mbs[3],i.elevationRange),i.serviceObbInRenderSR)}_computeRenderObb(i,s,r,n){if(t$2(s))s=E$4();else if(st(s))return s;let o=0,a=0;if(this._elevationContext&&r$4(n)&&Number.isFinite(n.min))switch(this._elevationContext.mode){case"relative-to-ground":o=this._elevationContext.geometryZWithOffset(i.center[2],this._renderCoordsHelper)+n.min-i.center[2],a=n.max-n.min;break;case"on-the-ground":o=n.min-i.center[2],a=n.max-n.min;}else this._elevationContext&&r<I&&(this._tmpPoint.x=i.center[0],this._tmpPoint.y=i.center[1],this._tmpPoint.z=i.center[2],o=m$1(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-i.center[2]);return a>0?(Be(i,this._indexSR,this._tmpObb,this.engineSR,o),Pe(this._tmpObb,0,a,this._viewingMode,s)):Be(i,this._indexSR,s,this.engineSR,o),s}isNodeVisible(e){const i=this.getRenderMbs(e);if(!this._isMBSinClippingArea(i))return !1;if(!this._useFrustumCulling)return !0;const s=this.getVisibilityObb(e);return r$4(s)?O$2(s,this._frustum):P$2(this._frustum,C$4(i))}isGeometryVisible(e){if(!this._useFrustumCulling)return !0;const i=e.geometryObb;return r$4(i)?O$2(i,this._frustum):this.isNodeVisible(e)}_isMBSinClippingArea(t){return !!t$2(this.clippingArea)||me(this.clippingArea,t)!==he.OUTSIDE}_screenSpaceDiameterMbs(e,t){const s=this.getRenderMbs(e),r=Math.sqrt(p$5(s,this._camPos)),n=r-s[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}calcCameraDistanceToCenter(e){const t=this.getRenderMbs(e),i=x$3(t,this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getRenderMbs(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/s$3(t)+i)/x$3(t,this._camPos);return Math.min(1,n)}hasLOD(e){return e.lodMetric!==a$1.None}_getDistancePlanarMode(e,t){const i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2],n=i*i+s*s,o=t[3];if(n<=o*o)return Math.abs(r);const a=Math.sqrt(n)-o;return Math.sqrt(r*r+a*a)}_getDistanceGlobeMode(e,t){const m=s$3(t),p=s$3(e)-m;q(this._tmp0,e,P$3(e,t)/v$1(e));const l=p$5(t,this._tmp0),_=t[3];if(l<=_*_)return Math.abs(p);{const i=q(this._tmp0,t,1/m),a=m,l=_*_/2/a,u=q(this._tmp1,i,a-l),d=e,g=e$3(this._tmp2,d,u),b=e$3(this._tmp2,g,q(this._tmp3,i,P$3(i,g))),v=u$1(this._tmp2,u,q(this._tmp2,b,_/s$3(b)));let x=x$3(d,v);if(p>=2e5){const e=e$3(this._tmp1,d,v);let t=P$3(e,i)/s$3(e);t<.08&&(t=1e-4),x/=t;}return x}}_getDistance(e,t){return this.engineSR===O$3(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e));}getLodLevel(e){if(e.lodMetric===a$1.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case a$1.ScreenSpaceRelative:{const i=this.getRenderMbs(e),s=this._getDistance(this._camPos,i),r=2*s/this._screenSizeFactor,n=s+i[3];return this._updateMinMaxDistance(n),e.maxError*t<=r}case a$1.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case a$1.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case a$1.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return !1}distToPOI(e){const t=this.getRenderMbs(e);return x$3(t,this._poi)-t[3]}distCameraToPOI(){return x$3(this._camPos,this._poi)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const Q=s$5.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),T=100,E=2,H=1e4,B=1e-4,k=1.2,R=500,z=1.5;let K=class extends(m$2(y$3)){constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new n$2({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new n$2,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new u$2,this._idleQueue=new i$4,this._elevationUpdateNodes=new n$2({deallocator:null}),this._errorCount=0;}get isMeshPyramid(){return "mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}get isGraphics3D(){return "points"===this.layer.profile}get useMaximumNumberOfFeatures(){return !this.isMeshPyramid&&(t$2(this.layer.priority)||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(A$2.I3S_INDEX);return new r(e,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(A$2.I3S_DATA);return new r(e,this.layer.apiKey)}get crsVertex(){return Re(this.layer)}get crsIndex(){return ve(this.layer)}get layer(){return this.layerView.i3slayer}get rootNodeVisible(){if(r$4(this._index)){const e=this._index.rootNode;if(r$4(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return !0}get index(){return this._index}initialize(){const{layerView:e,layer:t$1}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new t(e),this._defaultGeometrySchema=t$1.store.defaultGeometrySchema,this.disableIDBCache=a$3("disable-feature:idb-cache"),"fields"in t$1&&(this._fields=t$1.fields,this._attributeStorageInfo=t$1.attributeStorageInfo),this.addResolvingPromise(Promise.all([t$1.indexInfo,t$1.when(),e.when()]).then((([i])=>{if(this.destroyed||!e||e.destroyed)return;const{view:s}=e,{resourceController:r}=s;this._setClippingArea(s.clippingArea),this.own([l((()=>s?.pointsOfInterest?.focus?.renderLocation),(e=>this._pointOfInterestChanged(e)),h$3),l((()=>r.memoryController.memoryFactor),(()=>this._setCameraDirty()),U),l((()=>e.suspended),(e=>{const t=e?()=>this._updateViewData():()=>this._updateIdleState(!0),i=e?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(e&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(t,i);}),h$3),n(e.view.resourceController.scheduler,{update:(e,t)=>this._frame(e,t),needsUpdate:()=>this.updating}),l((()=>e.uncompressedTextureDownsamplingEnabled),(()=>this.restartNodeLoading())),l((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1;})),l((()=>s.state?.contentCamera),(()=>this._setCameraDirty())),l((()=>t$1.elevationInfo),(e=>this._elevationInfoChanged(e))),l((()=>t$1.effectiveScaleRange),(()=>this._scaleBoundsChanged())),l((()=>e.lodFactor),(()=>this._setCameraDirty())),l((()=>e.availableFields),(()=>this._requiredFieldsChange())),l((()=>e.holeFilling),(e=>r$4(this._index)&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new A(this.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?s.basemapTerrain:s.elevationProvider,o$4(s.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:this.lod<.5}),this._index=new p$2(t$1,i,this.indexStreamController,this._viewportQueries,Q,e.holeFilling,(t=>e.isNodeLoaded(t)),(t=>e.isNodeReloading(t)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,c.Leaf)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(t=>e.computeVisibilityObb?e.computeVisibilityObb(t):null),e?.computeNodeFiltering?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid),this._index.imModificationsChanged(!!e.hasModifications),this._startNodeLoading();}))),this._tmpPoint=v(0,0,0,this.crsIndex);}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;r$4(t)&&i?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);r$4(i)&&this._modificationsNodeFilteringArray.push(i);})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0);}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,X.prune(),r$4($)&&($.hide(),$=null);}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return [];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const s=W(e,i),r=W(t,i);return s>=0&&r>=0?{index:s,name:t[r].name,field:t[r],attributeStorageInfo:e[s]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();J(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading());}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading();}_setClippingArea(e){const t=u$3();e$4(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null;}_pointOfInterestChanged(e){r$4(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),r$4(this._index)&&(this._index.progressiveLoadPenalty=Y.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()));}updateClippingArea(e){this._setClippingArea(e),r$4(this._viewportQueries)&&r$4(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty();}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating();}updateElevationChanged(e,t){const i=this._index;if(t$2(i)||t$2(i.rootNode))return null;const s=this._elevationUpdateNodes;return s.clear(),se(e,t,i.rootNode,this.crsIndex,i,(e=>s.push(e.index))),s.length&&(s.forAll((e=>i.updateElevationChanged(e))),this._setCameraDirty()),s}getParentIndex(e){return r$4(this._index)&&this._index.getParentIndex(e)}removeAllGeometryObbs(){r$4(this._index)&&this._index.removeAllGeometryObbs();}_elevationInfoChanged(e){t$2(this._index)||(this._index.updateElevationInfo(e,this.isMeshPyramid),this._setCameraDirty());}_updateScaleHandles(){const e="scale-bounds";this._handles.remove(e),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),e);}_scaleBoundsChanged(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty();}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty();}_updateScaleInBoundingRect(e,t){const i=this._index;if(t$2(i))return;const s=i.rootNode;!t$2(s)&&zn(e,t,Z,this.crsIndex)&&this._loadedNodeScales.forEach(((e,t)=>{const s=i.getNode(t);r$4(s)&&g$2(Z,s.mbs)&&this._loadedNodeScales.set(t,this._computeScale(s));}));}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating();}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get isIntegratedMesh(){return "integrated-mesh"===this.layer.type}get areScaleBoundsActive(){const{minScale:e,maxScale:t}=r$5(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return t$2(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}get indexDepth(){return r$4(this._index)?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e;}_frame(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||t$2(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}_processLogError(e,t){try{this._process(e,t);}catch(i){this._errorCount<50?Q.error("Error during processing: "+i):50===this._errorCount&&Q.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++;}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||t$2(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this.isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t))),this._idleQueue.runTask(e),e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating());}_processIndex(e){if(t$2(this._index))return !1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading()||t===this._get("leavesReached")||this._set("leavesReached",t);}return this._index.load()}_prefetchIndex(){return !(t$2(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||t$2(this._index)||t$2(this._viewportQueries))return;const e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>R){if(this._featureLOD<=B)return;this._featureLOD/=z,this._stableFeatureLOD=!1;}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=H||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const s=this.lod,r=this._index.checkFeatureTarget(t,s);r!==s&&(this._featureLOD=r/this.baseLOD,this._stableFeatureLOD=!0);}else {if(!(i.estimate>t*k||e&&i.estimate>t))return;if(this._featureLOD<=B)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1;}this._featureLOD=Math.min(H,Math.max(B,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate();}_processCache(e){const t=this._index;if(t$2(t))return !1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let s=t.getParent(i);r$4(s)&&(!this.layerView.isNodeLoaded(s.index)&&this._isNodeInScaleBounds(s));s=t.getParent(s.index))if(this._enableFromGPUCache(s,c.Hole)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(t$2(this._index))return !1;let i=(this._isIdle?T:E)-this._loadingNodes.size;const s=this._index.updates;for(s.cancel.forEach(this._cancelNode,this),s.cancel=[];s.remove.length>0&&!e.done;)this.layerView.removeNode(s.remove.pop()),e.madeProgress();for(;s.update.length>0&&!e.done;){const t=this._index.getNode(s.update.pop());r$4(t)&&(this._updateLoadedNode(t),e.madeProgress());}for(;s.add.length>0&&!e.done&&i>0;){--i;const r=this._index.getNode(s.add.back());if(t$2(r)||r.cacheState!==s$6.Cached&&!this._hasNodeLoadToken(t))break;s.add.pop(),this._loadNode(r),e.madeProgress();}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear();}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e));}_hasNodeLoadToken(e){return !(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=E)&&(this._downloadingCount<I$3&&!this.dataStreamController.busy)}_evaluateUpdating(){let e=!1,t=0;if(this.layerView.suspended)e=this._cameraDirty,t=e?0:1;else {const i=(r$4(this._index)?this._index.getIndexMissing():0)+3*(r$4(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes;}this.updating=e,this.updatingProgress=t;}_updateViewData(){if(!this._cameraDirty||t$2(this._index)||t$2(this._viewportQueries))return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Y.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible");}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get lod(){return this._featureLOD*this.baseLOD}get baseLOD(){const e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}get lodDropFactor(){if(this.fixedFeatureTarget)return 1;const e=this.layerView.view.resourceController.memoryController;return (Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}isGeometryVisible(e){return r$4(this._index)&&this._index.isGeometryVisible(e.index)}updateVisibility(e){r$4(this._index)&&this._index.invalidateNodeVisibilityCache(e);}invalidateGeometryVisibility(e){r$4(this._index)&&this._index.invalidateGeometryVisibility(e);}invalidateVisibilityObbs(){r$4(this._index)&&this._index.invalidateVisibilityObbs();}modificationsChanged(){r$4(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0;}_shouldLoadNode(e){return !(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&(!(t$2(this._index)||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e))}_shouldDropNode(e){if(t$2(this._viewportQueries))return !1;const t=this.lodDropFactor;if(t>=1||!this._lodHandling.hasNoVisibleChildren(e))return !1;return Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||t$2(e)||t$2(this._viewportQueries))return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new g(this.layer,this.dataStreamController,Q,this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,ee.fadeout)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating();}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating());}_removeInvisibleNodes(e){const t=this._index;if(t$2(t)||t$2(this._viewportQueries))return !1;X.clear(),this.layerView.getLoadedNodeIndices(X);const i=0===this._viewportQueries.maxDistance,s=i?()=>!1:e=>this._shouldDropNode(e);return X.filterInPlace((e=>{const i=t.getNode(e);return t$2(i)||!t.isGeometryVisible(e)||s(i)||!this._isNodeInScaleBounds(i)})),X.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(X,e,ee.pop),!(i&&this.lodDropFactor<1)&&(0===X.length||(X.clear(),!1))}markNodeToRemove(e){X.push(e);}removeMarkedNodes(){this._removeNodes(X,w$3,ee.pop);}_removeNodes(e,t,i){const s=e.length;if(0!==s&&!t.done){for(r$4(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){const s=e.pop(),r=this._index;i===ee.fadeout&&this.layerView.nodeFadeoutEnabled&&r$4(r)&&r.isGeometryVisible(s)?this.layerView.fadeNode(s,a.FadeOut,!0):this.layerView.removeNode(s),t.madeProgress();}if(this._loadedNodeScales.size>0)for(let t=e.length;t<s;t++){const i=e.data[t];this._loadedNodeScales.delete(i);}}}_needsUpdate(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return !1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}_updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t);(J(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,t.signal)).then((i=>this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:i},t.signal)),t.signal))).catch((i=>{if(!g$1(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)})).catch((()=>{})).then((()=>{this._updatingNodes.delete(e.index),this._evaluateUpdating();})),this._evaluateUpdating();}_loadNode(e){if(this._loadingNodes.has(e.index))return void Q.error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then((i=>{i&&r$4(this._index)&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate());})).catch((e=>{if(!g$1(e))throw e})).finally((()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating();}));}_loadAndAddNode(e,t){return e.cacheState===s$6.Uncached?this._loadUncached(e,t).then((()=>!1)):this._loadCached(e,t).then((t=>!t&&(e.cacheState=s$6.Uncached,!0))).catch((t=>!g$1(t)&&(e.cacheState=s$6.Uncached,!0)))}_enableFromGPUCache(e,t){if(this._disableMemCache||t$2(this._index))return !1;if(t===c.Hole&&!this._index.useNodeAsHole(e.index))return !0;const i=this._loadCachedGPUData(e);return !!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e);return r$4(t)&&r$4(t.attributeInfo)&&J(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){r$4(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating();}updateLoadStatus(e,t){const i=this._index;r$4(i)&&i.updateChildrenLoaded(e,t?1:-1);}_loadCached(e,t){if(this._enableFromGPUCache(e,c.Leaf))return Promise.resolve(!0);const i=this.layerView;return !this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((()=>i.loadCachedNodeData(e,t,((t,i)=>this._nodeLoader.loadTextures(e,t,i)))),t).then((s=>{if(t$2(s))return !1;const r=this._requiredAttributes;return this.reschedule((()=>this._nodeLoader.loadAttributes(e,r,t)),t).then((a=>this.reschedule((()=>i.addCachedNodeData(e,s,{loadedAttributes:r,attributeData:a},t)),t))).then((()=>(this._nodeAdded(),!0)))})):Promise.resolve(!1)}_loadUncached(e,t){return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=s$6.Cached;})).catch((t=>{if(!g$1(t))throw Q.error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,r$4(this._index)&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&r$4(this._index)&&this._index.resetFailedNodes());}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);const t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_computeScale(e){this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];const t=e.mbs[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}_isNodeInScaleBounds(e){if(!this.areScaleBoundsActive)return !0;const t=this._getScale(e),{minScale:i,maxScale:s}=r$5(this.layer);return c$1(t,i,s)}updateStats(e){e.index=r$4(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),r$4(this._index)&&this._index.updateStats(e);}get test(){const e=this;return {index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate();},set disableIDBCache(t){e.disableIDBCache=t;},set ignoreServiceObb(t){r$4(e._index)&&(e._index.ignoreServiceObb=t);},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),r$4(this._index)&&this._index.requestUpdate();}geometryFilterChanged(e){const t=this._index;r$4(t)&&t.layerFilterChanged(e),this.requestUpdate();}};e$5([d$2({readOnly:!0})],K.prototype,"isMeshPyramid",null),e$5([d$2({readOnly:!0})],K.prototype,"isGraphics3D",null),e$5([d$2({readOnly:!0})],K.prototype,"useMaximumNumberOfFeatures",null),e$5([d$2({readOnly:!0})],K.prototype,"indexStreamController",null),e$5([d$2({readOnly:!0})],K.prototype,"dataStreamController",null),e$5([d$2({readOnly:!0})],K.prototype,"crsVertex",null),e$5([d$2({readOnly:!0})],K.prototype,"crsIndex",null),e$5([d$2()],K.prototype,"screenSizeFactor",void 0),e$5([d$2()],K.prototype,"featureTarget",void 0),e$5([d$2()],K.prototype,"fixedFeatureTarget",void 0),e$5([d$2()],K.prototype,"layerView",void 0),e$5([d$2()],K.prototype,"layer",null),e$5([d$2({})],K.prototype,"updating",void 0),e$5([d$2({})],K.prototype,"updatingProgress",void 0),e$5([d$2({readOnly:!0})],K.prototype,"leavesReached",void 0),e$5([d$2({constructOnly:!0})],K.prototype,"scaleVisibilityEnabled",void 0),e$5([d$2({readOnly:!0,dependsOn:[]})],K.prototype,"rootNodeVisible",null),K=e$5([n$5("esri.layers.graphics.controllers.I3SOnDemandController")],K);const X=new n$2({deallocator:null});let $;function J(e,t){return r$4(e)&&e.length===t.length&&e.every((e=>W(t,e.name)>=0))}function W(e,t){const i=t.toLowerCase();for(let s=0;s<e.length;s++)if(e[s].name.toLowerCase()===i)return s;return -1}const Y={factorIM:.2,factor3dObject:.05,distancePenalty:10},Z=u$3();var ee;!function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout";}(ee||(ee={}));const te=K;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class s extends n$6{constructor(){super(...arguments),this._map=new Map;}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e});}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let r=0;r<e.length;r++){const s=e[r],o=s.objectId,n=this._map.get(o);n?(t.add(o),s!==n&&(e[r]=n),++n.refCount):(s.refCount=1,this._map.set(o,s));}const s=t.size>0?e.filter((e=>!t.has(e.objectId))):e;s.length>0&&this.emit("change",{added:s,removed:[]});}removeMany(e){const t=[];for(const s of e){const e=s.objectId,r=this._map.get(e);null!=r&&--r.refCount<=0&&(this._map.delete(e),t.push(s));}t.length>0&&this.emit("change",{added:[],removed:t});}removeManyByObjectId(e){const t=[];for(const s of e){const e=this._map.get(s);null!=e&&--e.refCount<=0&&(this._map.delete(s),t.push(e));}t.length>0&&this.emit("change",{added:[],removed:t});}toArray(){return [...this._map.values()]}find(e){let s;return n$7(this._map,(t=>!!e(t)&&(s=t,!0))),s}forEach(e){this._map.forEach((t=>e(t)));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const p=s$5.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");class f{constructor(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=new AbortController,this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=j,this.memCache=t.newCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null));}destroy(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null;}createInteractiveEditSession(e){this.changedObjectIds.add(e),t$2(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const s=this.interactiveEditingSessions,i=new y(e,{rollback:()=>{F$2(s,i),0===s.length&&(this.interactiveEditingSessions=null);},commit:t=>{for(const[s,i]of t)this.updateValue(e,s,i);}});return s.unshift(i),i}async apply(e,t,s){if(t$2(t))return;const{loadedAttributes:i,attributeData:r}=t;if(t$2(i)||0===i.length||t$2(r))return;if(await y$4(this.pendingFetchChangedObjectIds,s),0===this.changedObjectIds.size)return;const a={loadedAttributes:i,attributeData:r},n=this._getOverridesFromCache(e,a,this.changedObjectIds),{objectIds:o,fieldNames:d}=n,h=await this._queryOverridesFromAssociatedLayer(o,d,s);t$2(h)||this._processOverridesFromAssociatedLayer(e,h,d,a);}updateValue(e,t,s){this.changedObjectIds.add(e),this._cacheValue(e,t,s);}_cacheValue(e,t,s){this.memCache.put(this._getCacheKey(e,t),s,this._memCacheValueSize(s));}_getOverridesFromCache(e,{loadedAttributes:t,attributeData:s},i){const r=new Set,a=new Array;for(const o of t)a[o.index]=s[o.name];const n=new Set;for(let o=0;o<e.length;o++){const s=e[o];if(i.has(s))for(const e of t){const t=this._fromCache(s,e.index);void 0===t?(r.add(s),n.add(e.name)):a[e.index][o]=t;}}return {objectIds:Array.from(r),fieldNames:Array.from(n)}}_fromCache(e,t){const s=this._fromInteractiveEditingSession(e,t);if(void 0!==s)return s;const i=this._getCacheKey(e,t);return this.memCache.get(i)}_fromInteractiveEditingSession(e,t){if(!t$2(this.interactiveEditingSessions))for(const s of this.interactiveEditingSessions){if(s.objectId!==e)continue;const i=s.get(t);if(void 0!==i)return i}}_getCacheKey(e,t){return `${e}-${t}`}async _queryOverridesFromAssociatedLayer(e,t,r){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this._logMaximumObjectsExceededWarning());const a=e$2(this.layer.associatedLayer),n=a.createQuery();n.where="1=1",n.returnGeometry=!1,n.outFields=[a.objectIdField,...t],n.cacheHint=!0,n.objectIds=e;const o=a$6(a),c=e.length>o?d$3(e,o).map((e=>{const t=n.clone();return t.objectIds=e,u$4(t$3(a,t,{signal:r}))})):[u$4(t$3(a,n,{signal:r}))];return (await Promise.all(c)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])}_logMaximumObjectsExceededWarning(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${m$3(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,p.warn("#queryOverrides()",this.layer.title,`${e}.`);}_processOverridesFromAssociatedLayer(e,t,s,{loadedAttributes:i,attributeData:r}){const a=e$2(this.layer.associatedLayer).objectIdField,n=s.map((e=>r[e])),o=new Map(i.map((e=>[e.name,e.index]))),c=s.map((e=>o.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const d of t){const e=d.attributes[a];for(let t=0;t<s.length;t++){const i=c[t],r=h.get(e),a=d.attributes[s[t]];n[t][r]=a,this._cacheValue(e,i,a);}}}_memCacheValueSize(e){return "string"==typeof e?n$8(e):t$4()}async _fetchChangedObjectIds(t){const s=this.layer;if(await s.load({signal:t}),this.changedObjectIds.clear(),t$2(s.associatedLayer)||!s.associatedLayer.capabilities?.operations?.supportsChangeTracking)return;const i=this._getFetchChangedObjectIdsServerGen();if(t$2(i))return null;const a=s.associatedLayer.layerId,n=await a$4(U$1(`${s.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${a}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:a,serverGen:i}])},timeout:C,signal:t})),o=n.ok&&n.value.data?.edits?m$4(n.value.data.edits[0],"objectIds","updates"):null;if(r$4(o)){const e=Math.min(this._maximumNumberOfEditOVerrides,o.length);e<o.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=o.sort(((e,t)=>e-t));for(let s=0;s<e;s++)this.changedObjectIds.add(t[s]);}}_getFetchChangedObjectIdsServerGen(){const e=this.layer;if(r$4(e.serviceUpdateTimeStamp)&&r$4(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return r$4(t)&&r$4(t.serverGens)&&r$4(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}get test(){const e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,s=this;return {changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return s._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){s._maximumNumberOfEditOVerrides=e;}}}}class y{constructor(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=O.ACTIVE;}get(e){return this.updates.get(e)}set(e,t){this.isActive&&this.updates.set(e,t);}rollback(){this.isActive&&(this.state=O.ROLLED_BACK,this.options.rollback());}commit(){this.isActive&&(this.state=O.COMMITTED,this.options.commit(this.updates),this.updates.clear());}get isActive(){return this.state===O.ACTIVE}}var O;!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.COMMITTED=1]="COMMITTED",e[e.ROLLED_BACK=2]="ROLLED_BACK";}(O||(O={}));const C=1e4,j=5e4;

export { C$1 as C, D$1 as D, F, S, a, s$1 as b, e, f, s, te as t, w };
