import { r as r$2, e as e$2, d as d$1, n as n$3, v as n$4, aA as n$7, t as t$6, h as e$a, aS as s$2, s as s$3, ag as c$4, E as E$4, J as g$3, aK as C$2, X as f$3, bx as d$3, bf as m$3, bc as o$a } from './cast-3d5be210.js';
import { a as a$5, n as n$a } from './asyncUtils-96c00c9e.js';
import { j as j$2 } from './Collection-a38e0489.js';
import { h as h$2, l as l$3, U as U$1 } from './reactiveUtils-bd6fe823.js';
import { u as u$7 } from './screenUtils-31d073db.js';
import { W as W$1 } from './unitUtils-a0a11e54.js';
import { P, n as n$8, e as e$9, s as s$1, q, k as j$1, D as r$4, v, a as o$8 } from './mathUtils-559a53d9.js';
import { n as n$6, t as t$8 } from './vec3f32-03e33744.js';
import { z as zn } from './projection-fbd5d346.js';
import { a as a$1, b, j, C as C$1, V, E as E$1, k, A as A$1 } from './aaBoundingBox-b312516d.js';
import { b as b$1, u as u$9 } from './aaBoundingRect-5e1a4e52.js';
import { p, T } from './frustum-95850b85.js';
import { v as v$1 } from './dehydratedFeatures-7b45465d.js';
import { u as u$8, p as p$2 } from './Field-2973a5cf.js';
import { I as I$1 } from './fieldUtils-240a3b99.js';
import { i as i$4, L as L$1 } from './Scheduler-ed7a36dc.js';
import { r as r$5 } from './commonProperties-fca3036e.js';
import { n as n$9 } from './LayerView3D-eec9cc5a.js';
import { a as n$2 } from './LercDecoder-0b4fb3f9.js';
import { ay as G, az as K$1, aA as J, aB as D, ak as Be, aC as r$3, aD as o$5, aE as o$6, aF as L, aG as N, O as P$1, aH as x$1, aI as Ue, aJ as _e$1, an as A$2, t as t$9 } from './SceneView-ed3703c9.js';
import { a as a$6, c as c$5, d as d$2 } from './PointCloudWorkerUtil-b9ef0d1e.js';
import { g as g$2 } from './Graphic-93f45ded.js';
import { x, u as u$5 } from './mat4-d5df0e58.js';
import { e as e$8 } from './jsonUtils-f3f35e7f.js';
import { p as p$1 } from './sphere-4710475c.js';
import { u as u$3, W, b as a$4, c as c$1 } from './OrderIndependentTransparency-b8c8f539.js';
import { a as i$1, V as o$3, U as u$4, H as o$4, e as e$3, f as e$4, n as n$5, r as a$2, a1 as a$3, g as e$5, h as o$7, E, al as e$6, an as f$1, t as t$3, a2 as i$2, k as e$7, K as A, bA as m$2, l as t$7, C as E$3 } from './objectResourceUtils-e575a410.js';
import { q as i$3, s as t$5, U } from './viewpointUtils-4c294048.js';
import { O } from './VertexAttribute-ef09ced9.js';
import { I, C, E as E$2, F } from './enums-4770f29d.js';
import { f as f$2, c as c$2 } from './FramebufferObject-bfb23fd2.js';
import { t as t$4 } from './VertexElementDescriptor-3b53aa99.js';
import { c as c$3 } from './PopupSceneLayerView-cfd38f5f.js';
import { u as u$6 } from './LayerView-1ee5d9ed.js';
import { o as o$9, r as r$6, c as c$6 } from './GoTo-929e809f.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class e$1 extends n$2{constructor(t){super("PointCloudWorker","transform",{transform:t=>this._getTransferList(t)},t);}_getTransferList(r){const e=[r.geometryBuffer];if(r$2(r.primaryAttributeData)&&r.primaryAttributeData.buffer&&e.push(r.primaryAttributeData.buffer),r$2(r.modulationAttributeData)&&r.modulationAttributeData.buffer&&e.push(r.modulationAttributeData.buffer),r$2(r.filterAttributesData))for(const a of r.filterAttributesData)r$2(a)&&a.buffer&&e.push(a.buffer);for(const t of r.userAttributesData)t.buffer&&e.push(t.buffer);return e}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
function t$2(e,t,g){for(let n=0;n<t.length;n++)r$1[n]=!1,o$2[n]=null;for(let r=0;r<e.length;r++)n$1[r]=!1,l$2[r]=null;for(let n=0;n<t.length;n++){const o=h$1(t[n],e,g);o>=0&&(r$1[n]=!0,null!=l$2[o]?l$2[o].push(t[n]):l$2[o]=[t[n]]);}for(let l=0;l<e.length;l++){const r=h$1(e[l],t,g);r>=0&&(n$1[l]=!0,null!=o$2[r]?o$2[r].push(e[l]):o$2[r]=[e[l]]);}const u=[];for(let r=0;r<e.length;r++)null!=l$2[r]||n$1[r]||u.push({load:[],remove:[e[r]]});for(let n=0;n<t.length;n++)null!=o$2[n]||r$1[n]||u.push({load:[t[n]],remove:[]});for(let n=0;n<t.length;n++)null!=o$2[n]&&(o$2[n].length>1||o$2[n][0]!==t[n])&&u.push({load:[t[n]],remove:o$2[n]});for(let n=0;n<e.length;n++)null!=l$2[n]&&(l$2[n].length>1||l$2[n][0]!==e[n])&&u.push({load:l$2[n],remove:[e[n]]});return u}const n$1=[!1],l$2=[null],r$1=[!1],o$2=[null];function h$1(e,t,n){let l=e;for(;l>0;){const e=t.indexOf(l);if(e>=0)return e;l=n.getParentId(l);}return t.indexOf(l)}function g$1(t,n,l){return t.sort(((t,r)=>{if(0===t.load.length&&0===r.load.length)return 0;if(0===t.load.length)return -1;if(0===r.load.length)return 1;if(0===t.remove.length&&0===r.remove.length){const o=l.getRenderCenter(t.load[0]),h=l.getRenderCenter(r.load[0]);return P(o,n)-P(h,n)}if(0===t.remove.length)return -1;if(0===r.remove.length)return 1;if(1===t.load.length&&1===r.load.length){const o=l.getRenderCenter(t.load[0]),h=l.getRenderCenter(r.load[0]);return P(o,n)-P(h,n)}if(1===t.load.length)return -1;if(1===r.load.length)return 1;{const o=l.getRenderCenter(t.remove[0]),h=l.getRenderCenter(r.remove[0]);return P(o,n)-P(h,n)}}))}function u$2(e,t,n){for(let l=0;l<e.length;++l){const r=e[l];r.load.length>t&&1===r.remove.length&&d(e,r,n);}}function d(e,t,n){const l=[t.remove[0]],r=[];for(;1===l.length;){const e=l.pop();r.length=0;for(let o=0;o<t.load.length;o++){let h=t.load[o],g=n.getParentId(h);for(;g!==e;)h=g,g=n.getParentId(h);let u=l.indexOf(h);u<0&&(u=l.length,l.push(h),r.push([])),r[u].push(t.load[o]);}}t.load=l;for(let o=0;o<l.length;o++)r[o].length>1?e.push({remove:[l[o]],load:r[o]}):l[o]=r[o][0];}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class h{constructor(e,t,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=s;}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);const n=g(t,this._nodeSR,this._renderSR,s);this._pages[e]={nodes:t,renderObbs:n,parents:new Uint32Array(this.pageSize)},u$1(this._pages,this.pageSize);}hasPage(e){return !!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[l$1(e,t)].nodes[c(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[l$1(e,t)].renderObbs[c(e,t)]}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,t){const s=this.pageSize;G(t,this._pages[l$1(e,s)].renderObbs[c(e,s)]);}getParentId(e){const t=this.pageSize;return this._pages[l$1(e,t)].parents[c(e,t)]}hasNodes(e,t){const s=l$1(e,this.pageSize),n=l$1(e+t-1,this.pageSize);for(let i=s;i<=n;i++)if(null==this._pages[i])return !1;return !0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n);}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:a$1()};return (e,s)=>a(t,e,s)}}function a(e,n,i){const p=e.index;if(!p.hasNodes(0,1))return;const h=e.queue;h.length=0,h.push(0);const a=e.masks;for(a.length=0,a.push(0);h.length>0;){const g=h.pop();let u=a.pop();const c=p.getNode(g),d=p.getRenderObb(g);let f=!0;if(null!=n.clippingBox){const i=1<<n.frustum.length;if(0==(u&i)){const o=K$1(d,e.tempAabb);b(n.clippingBox,o)?u|=i:j(n.clippingBox,o)||(f=!1);}}for(let e=0;e<n.frustum.length&&f;e++){const t=1<<e;if(0==(u&t)){const s=J(d,n.frustum[e]);s>0?f=!1:s<0&&(u|=t);}}if(i.predicate(g,c,f)){const e=c.firstChild,t=c.childCount;let s=!1;const n=l$1(e,p.pageSize),r=l$1(e+t-1,p.pageSize);for(let o=n;o<=r;o++)if(!p.hasPage(o)){i.pageMiss(g,o),s=!0;break}if(!s)for(let i=0;i<t;i++)h.push(e+i),a.push(u);}}}function g(e,t,s,i){const r=new D(e.length);for(let o=0;o<e.length;o++)Be(e[o].obb,t,r.obbs[o],s,i);return r.obbs}function u$1(e,t){const s=[0];for(;s.length;){const n=s.pop(),i=e[l$1(n,t)].nodes[c(n,t)];for(let r=0;r<i.childCount;r++){const o=i.firstChild+r;null!=e[l$1(o,t)]&&(e[l$1(o,t)].parents[c(o,t)]=n,s.push(o));}}}function l$1(e,t){return e/t|0}function c(e,t){return e%t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
function t$1(t){const e=t.renderer,n=e&&e.type,o=e&&t.renderer.toJSON()||null;let r=null,i=!1;"point-cloud-unique-value"===n||"point-cloud-stretch"===n||"point-cloud-class-breaks"===n?r=u(t.attributeStorageInfo,e.field):"point-cloud-rgb"===n?(r=l(t.attributeStorageInfo,e.field),i=null!=r):(r=l(t.attributeStorageInfo,"RGB"),i=null!=r);let a=null;return e&&e.colorModulation&&(a=u(t.attributeStorageInfo,e.colorModulation.field)),{rendererJSON:o,isRGBRenderer:i,primaryAttribute:r,modulationAttribute:a}}function e(t){const e=t.filters;return e?e.map((e=>({filterJSON:e.toJSON(),attributeInfo:u(t.attributeStorageInfo,e.field)}))):[]}function n(t){const e=t&&t.pointSizeAlgorithm;return e&&"splat"===e.type?e:null}function o$1(t){const e=t&&t.pointSizeAlgorithm;return e&&"fixed-size"===e.type?e:null}function r(t){const e=t&&t.pointSizeAlgorithm;return !(!e||!e.type)&&"fixed-size"===e.type}function l(t,e){for(const n of t)if(n.name===e&&null!=n.attributeValues&&"UInt8"===n.attributeValues.valueType&&3===n.attributeValues.valuesPerElement)return {name:e,storageInfo:n,useElevation:!1};return null}function u(t,e){for(const n of t)if(n.name===e){const t="embedded-elevation"===n.encoding;return {name:e,storageInfo:t?null:n,useElevation:t}}return "elevation"===e.toLowerCase()?{name:e,storageInfo:null,useElevation:!0}:null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let t=class extends g$2{constructor(r){super(r);}};e$2([d$1({constructOnly:!0,clonable:"reference"})],t.prototype,"pointCloudMetadata",void 0),t=e$2([n$3("esri.views.3d.layers.i3s.PointGraphic")],t);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class s{constructor(e){this._context=e,this._highlights=new Set;}get hasHighlights(){return this._highlights.size>0}destroy(){this._highlights=null;}add(t){const i=new o(t);return this._highlights.add(i),this._enableSet(i),n$4((()=>this._removeSet(i)))}_removeSet(e){this._disableSet(e),this._highlights.delete(e);}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode((t=>this._enableSetForNode(e,t))));}_enableSetForNode(e,t){if(!e.enabled)return;const i=e.ids.get(t.id);i&&i.forEach((i=>this._context.addHighlight(t,i,e.id)));}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode((t=>this._disableSetForNode(e,t))));}_disableSetForNode(e,t){e.enabled||this._context.removeHighlight(t,e.id);}nodeAdded(e){this._highlights.forEach((t=>this._enableSetForNode(t,e)));}nodeRemoved(e){this._highlights.forEach((t=>this._disableSetForNode(t,e)));}removeAll(){this._highlights.forEach((e=>this._disableSet(e)));}}class o{constructor(e){this.id=new r$3(u$3.Highlight),this.ids=new Map,this.enabled=!1;for(const i of e)r$2(i)&&this._add(i.nodeId,i.pointId);}_add(e,t){const i=this.ids.get(e);i?i.add(t):this.ids.set(e,new Set([t]));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
function m$1(m){const f=new i$1,g=m.output===o$3.Color,u=m.output===o$3.Depth,v=m.output===o$3.Highlight,{vertex:w,fragment:S}=f;return f.extensions.add("GL_OES_standard_derivatives"),f.include(u$4,m),f.attributes.add(O.POSITION,"vec3"),f.attributes.add(O.COLOR,"vec3"),w.uniforms.add(new o$4("modelView")),w.uniforms.add(new e$3("proj",((e,i)=>i.camera.projectionMatrix))),w.uniforms.add(new o$5("screenMinMaxSize")),w.uniforms.add(new o$5("pointScale")),w.uniforms.add(new o$6("clipMin")),w.uniforms.add(new o$6("clipMax")),u?(w.uniforms.add(new e$4("nearFar",((e,i)=>i.camera.nearFar))),f.varyings.add("depth","float")):m.output!==o$3.Highlight&&f.varyings.add("vColor","vec3"),w.code.add(n$5`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = modelView * vec4(position, 1.0);

      float pointSize = pointScale.x;
      vec4 position = proj * camera;
     ${m.drawScreenSize?n$5`
      float clampedScreenSize = pointSize;`:n$5`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = proj * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = pointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = proj * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${u?n$5`depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);`:""}
     ${g?n$5`vColor = color;`:""}
    }
  `),S.include(a$2,m),v&&f.include(a$3),S.code.add(n$5`
    void main(void) {
      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
      float r2 = dot(vOffset, vOffset);

      if (r2 > 0.25) {
        discard;
      }
      ${u?n$5`gl_FragColor = float2rgba(depth);`:""}
      ${v?n$5`outputHighlight();`:""}
      ${g?n$5`gl_FragColor = vec4(vColor, 1.0);`:""}
    }
  `),f}const f=Object.freeze(Object.defineProperty({__proto__:null,build:m$1},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class m extends e$5{constructor(e,r,t){super(e,r,t);}initializeProgram(e){const r=m.shader.get().build(this.configuration);return new o$7(e.rctx,r,E)}initializePipeline(){return W({depthTest:{func:I.LESS},depthWrite:a$4,colorWrite:c$1,stencilWrite:this.configuration.hasOccludees?e$6:null,stencilTest:this.configuration.hasOccludees?f$1:null})}}m.shader=new t$3(f,(()=>import('./PointRenderer.glsl-f8cfc2d2.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class i extends i$2{constructor(){super(...arguments),this.output=o$3.Color,this.hasSlicePlane=!1,this.drawScreenSize=!1,this.hasOccludees=!1;}}e$2([e$7({count:o$3.COUNT})],i.prototype,"output",void 0),e$2([e$7()],i.prototype,"hasSlicePlane",void 0),e$2([e$7()],i.prototype,"drawScreenSize",void 0),e$2([e$7()],i.prototype,"hasOccludees",void 0),e$2([e$7({constValue:!0})],i.prototype,"hasSliceInVertexProgram",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const K={positions:[new t$4(O.POSITION,3,C.FLOAT,0,12)],colors:[new t$4(O.COLOR,3,C.UNSIGNED_BYTE,0,3,!0)]};class Q{constructor(e){this._params=e,this.type=i$3.PCL,this.isGround=!1,this._highlights=new s({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this._addHighlight(e,i,t),removeHighlight:(e,i)=>this._removeHighlight(e,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=a$1(C$1),this._techniqueConfig=new i,this.tempMatrix4=e$8(),this.tempVec3=n$6(),this.nodes=new n$7;}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRepository,e.requestRender();}uninitializeRenderContext(){}intersect(e,i,t,s){const n=n$8(),r=n$8(),o=n$8(),h=n$8(),g=p(),p$2=e.camera.perScreenPixelRatio/2,x=e.camera.near,w=this._getSizeParams();e$9(r,s,t);const R=1/s$1(r);q(r,r,R),j$1(o,r),r$4(g,r[0],r[1],r[2],-P(r,t));const y=new re,H=new re,T=new Array,L$1=a$1(),F=a$1(this._clipBox);V(F,-t[0],-t[1],-t[2],F),this.nodes.forAll((l=>{const c=l.splatSize*this._scaleFactor;let d=L(l.obb,g),f=N(l.obb,g);d-=ee(c,d+x,w,p$2,l.isLeaf),f-=ee(c,f+x,w,p$2,l.isLeaf);const _=f<0,S=null!=y.dist&&null!=H.dist&&y.dist<d*R&&H.dist>f*R;if(_||S)return;const A=$(c,f+x,w,p$2,l.isLeaf);if(!P$1(l.obb,t,r,A))return;const q=A*A;K$1(l.obb,L$1),V(L$1,-t[0],-t[1],-t[2],L$1);const E=!b(F,L$1);e$9(h,l.origin,t);const V$1=l.coordinates.length/3;for(let a=0;a<V$1;a++){if(n[0]=h[0]+l.coordinates[3*a],n[1]=h[1]+l.coordinates[3*a+1],n[2]=h[2]+l.coordinates[3*a+2],E&&!E$1(F,n))continue;const d=P(n,r),g=v(n)-d*d;if(g>q)continue;let f=d+x;const _=ee(c,f,w,p$2,l.isLeaf);if(d-_<0)continue;f-=_;const S=$(c,f,w,p$2,l.isLeaf);if(g>S*S)continue;const z=(d-_)*R,b=e=>(e.point=ie(l,a,e.point),e.dist=z,e.normal=o,e.node=l,e.pointId=a,e.layerUid=this.layerUid,e);if((null==y.dist||z<y.dist)&&(null==i||i(t,s,z))&&b(y),e.options.store!==t$5.MIN&&(null==H.dist||z>H.dist)&&(null==i||i(t,s,z))&&b(H),e.options.store===t$5.ALL&&(null==i||i(t,s,z))){const e=new re;T.push(b(e));}}}));const V$1=e=>{const{layerUid:i,node:t,pointId:s}=e;return {point:e.point,layerUid:i,graphicUid:s,createGraphic:()=>this._params.createGraphic(t,s,e.point)}},U$1=(e,i)=>{const t=V$1(i);e.set(this.type,t,i.dist,i.normal);};if(oe(y)){const i=e.results.min;(null==i.dist||y.dist<i.dist)&&U$1(i,y);}if(oe(H)&&e.options.store!==t$5.MIN){const i=e.results.max;(null==i.dist||H.dist>i.dist)&&U$1(i,H);}if(e.options.store===t$5.ALL){const i=p$1(t,s);for(const t of T){const s=U(i);U$1(s,t),e.results.all.push(s);}}}prepareTechnique(e){if(0===this.nodes.length||e.pass!==A.MATERIAL&&e.pass!==A.MATERIAL_DEPTH&&e.pass!==A.MATERIAL_HIGHLIGHT)return null;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i);}));const i=this._getSizeParams();return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.output=e.pass===A.MATERIAL_DEPTH?o$3.Depth:e.pass===A.MATERIAL_HIGHLIGHT?o$3.Highlight:o$3.Color,this._techniqueRep.releaseAndAcquire(m,this._techniqueConfig,this._technique)}render(e,i){const t=e.rctx,s=t.bindTechnique(i,he,e.bindParameters),n=e.bindParameters.camera,h=this._clipBox,a=!k(h,C$1,((e,i)=>e===i));a||(o$8(this.tempVec3,-1/0,-1/0,-1/0),s.setUniform3fv("clipMin",this.tempVec3),o$8(this.tempVec3,1/0,1/0,1/0),s.setUniform3fv("clipMax",this.tempVec3));const l=this._getSizeParams(),c=n.pixelRatio;l.drawFixedSize&&s.setUniform2f("pointScale",l.fixedSize*c,n.fullHeight),this.nodes.forAll((d=>{if(0===d.coordinates.length||e.isHighlightPass&&!d.highlights)return;if(s.setUniform2f("screenMinMaxSize",l.screenMinSize*c,Z(d.isLeaf)*c),!l.drawFixedSize){const e=d.splatSize*this._scaleFactor;s.setUniform2f("pointScale",e*c,n.fullHeight/c);}const u=d.origin;a&&(o$8(this.tempVec3,h[0]-u[0],h[1]-u[1],h[2]-u[2]),s.setUniform3fv("clipMin",this.tempVec3),o$8(this.tempVec3,h[3]-u[0],h[4]-u[1],h[5]-u[2]),s.setUniform3fv("clipMax",this.tempVec3)),x(this.tempMatrix4,u),u$5(this.tempMatrix4,n.viewMatrix,this.tempMatrix4),s.setUniformMatrix4fv("modelView",this.tempMatrix4),i.bindDraw(new m$2(u),e.bindParameters),t.bindVAO(d.vao),e.isHighlightPass?this._renderHighlightFragments(t,d):t.drawArrays(E$2.POINTS,0,d.coordinates.length/3);}));}_renderHighlightFragments(e,s){const n=s.highlights;if(t$6(n))return;let r=e$a(n[0].component),o=r+1;for(let i=1;i<n.length;i++){const s=e$a(n[i].component);if(s!==o){const i=o-r;i>0&&e.drawArrays(E$2.POINTS,r,i),r=s;}o=s+1;}const h=o-r;h>0&&e.drawArrays(E$2.POINTS,r,h);}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender());}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender());}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender());}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender());}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender());}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender());}get sizePx(){return this._sizePx}set clippingBox(e){A$1(this._clipBox,e||C$1);}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender());}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender();}removeNode(e){let i=null;return this.nodes.filterInPlace((t=>t.id!==e||(i=t,t.vao=s$2(t.vao),this._highlights.nodeRemoved(t),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e);}removeAll(){this.nodes.forAll((e=>e.vao=s$2(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender();}highlight(e){return this._highlights.add(e)}_addHighlight(e,i,t){e.highlights=se(e.highlights,i,t),this._requestRender();}_removeHighlight(e,i){e.highlights=ne(e.highlights,i),this._requestRender();}_initNode(e,i){const t=e.rctx;i.vao=new f$2(t,E,K,{positions:c$2.createVertex(t,F.STATIC_DRAW,i.coordinates),colors:c$2.createVertex(t,F.STATIC_DRAW,i.rgb)});}_requestRender(){this._context&&this._context.requestRender();}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes;return {drawScreenSpace:i,drawFixedSize:e,fixedSize:i?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}}function X(e){return e.hasOwnProperty("splatSize")}function Z(e){return e?256:64}function $(e,i,t,s,n){if(t.drawScreenSpace)return t.fixedSize*i*s;const r=Z(n)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,r):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),r):Math.min(e/2,r)}function ee(e,i,t,s,n){return t.drawScreenSpace?0:$(e,i,t,s,n)}function ie(e,t,s){return t$6(s)&&(s=n$8()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function te(i){return r$2(i.component)?i.component:-1}function se(e,t,s){t$6(e)&&(e=[]);const n={component:t,id:s};e.push(n);const r=te(n);let o=e.length-1;for(;o>0&&r<te(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function ne(e,t){if(t$6(e))return e;const s=e.filter((e=>e.id!==t));return 0===s.length?null:s}class re{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid="";}}function oe(i){return r$2(i.dist)&&r$2(i.point)&&r$2(i.pointId)&&r$2(i.node)}const he=new t$7;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const ce=s$3.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),_e=8,me=p();let ge=class extends(c$3(n$9(u$6))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new i$4,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[];}get pointScale(){const e=n(this.layer&&this.layer.renderer),t=1;return e&&null!=e.scaleFactor?e.scaleFactor:t}get useRealWorldSymbolSizes(){const e=o$1(this.layer&&this.layer.renderer),t=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:t}get pointSize(){const e=o$1(this.layer&&this.layer.renderer),t=0;return e&&null!=e.size?e.size:t}get inverseDensity(){const e=96;return this.layer&&this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5}get availableFields(){const e$1=t$1(this.layer),t=new Set;e$1.primaryAttribute&&t.add(e$1.primaryAttribute.name),e$1.modulationAttribute&&t.add(e$1.primaryAttribute.name);const i=e(this.layer);if(i)for(const r of i)t.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of I$1(this.layer.fieldsIndex,this.layer.outFields))t.add(r);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=a$1(),t=this.view.renderSpatialReference;return x$1(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=W$1(this.layer.spatialReference),i=r$5(e.unit);return c$4(e.offset,0)*i/t}return 0}initialize(){const e=this.view.resourceController;this._worker=new e$1((t=>e.schedule(t))),this.addResolvingPromise(this._worker.promise),this._tmpPoint=v$1(0,0,0,this.layer.spatialReference),Ue(this.layer),_e$1(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(A$2.I3S_INDEX),this._dataRequester=e.createStreamDataRequester(A$2.I3S_DATA),this._initRenderer();const t=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(this.layer.uid),this.updatingHandles.add((()=>this._clippingBox),(()=>this._setUpdateViewNeeded()),h$2),this.updatingHandles.add((()=>this._elevationOffset),(()=>this._elevationOffsetChanged()),h$2),this.updatingHandles.add((()=>this.layer.renderer),(()=>this._rendererChanged()),h$2),this.updatingHandles.add((()=>this.layer.filters),(()=>this._reload()),h$2),this.updatingHandles.add((()=>this.layer.outFields),(()=>this._reload()),h$2),this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this._setUpdateViewNeeded())),this.updatingHandles.add((()=>this.view.state.contentCamera),(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),l$3((()=>i.memoryFactor),(()=>this._setUpdateViewNeeded()),U$1)]),this.addResolvingPromise(t),this.when((()=>{this.handles.add([e.scheduler.registerTask(L$1.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add((()=>this.suspended),(e=>{e?this._clearNodeState():this._setUpdateViewNeeded();}),h$2)]);}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll();}));}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading();}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null;}_initRenderer(){this._renderer=new Q({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add((()=>this._clippingBox),(e=>this._renderer.clippingBox=e),h$2),this.updatingHandles.add((()=>this.suspended),(e=>this._setPointsVisible(!e)),h$2),this.updatingHandles.add((()=>this.pointScale),(e=>this._renderer.scaleFactor=e),h$2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add((()=>this.useRealWorldSymbolSizes),(e=>this._renderer.useRealWorldSymbolSizes=e),h$2),this.updatingHandles.add((()=>this.pointSize),(e=>{const t=u$7(e);this._renderer.size=e,this._renderer.sizePx=t;}),h$2),this.updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._renderer.slicePlaneEnabled=e),h$2),this.updatingHandles.add((()=>this.inverseDensity),(()=>this._setUpdateViewNeeded()),h$2),this.updatingHandles.add((()=>this.maximumPointCount),(()=>this._setUpdateViewNeeded()),h$2),this.updatingHandles.add((()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor),(e=>{this._lodFactor=e,this._setUpdateViewNeeded();}),h$2);}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1);}_createGraphic(e,t$1,i){const r=r$2(e.pointIdFilterMap)?e.pointIdFilterMap[t$1]:t$1,s=this.view.computeMapPointFromVec3d(i),o=this._createGraphicAttributes(e,r);return new t({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t$1,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:s,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_encodeGraphicAttribute(e,t,i,r){const s=e.storageInfo&&e.storageInfo.attributeValues,o=s?s.valuesPerElement:1;if(1===o)r[e.name]=t[i];else if("UInt8"===s.valueType&&o<=4){let s=0;const n=i*o;for(let e=n;e<n+o;e++)s=(s<<8)+t[e];r[e.name]=s;}else r[e.name]=void 0;}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([E$3.OPAQUE_MATERIAL],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1);}_rendererChanged(){this._renderer.useFixedSizes=r(this.layer.renderer),this._reload();}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded();}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages();}_scaleUpdateHandler(e){const t=this.layer.effectiveScaleRange;o$9(t.minScale,t.maxScale)?zn(e.extent,e.spatialReference,be,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);b$1(be,r.obb.center)&&this._nodeScales.set(i,e.scale);})),this._setUpdateViewNeeded()):this._nodeScales.clear();}_displayNodes(e){this._workQueue=t$2([...this._renderedNodes],e,this._index),g$1(this._workQueue,this.view.state.contentCamera.viewForward,this._index),u$2(this._workQueue,_e,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended");}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading();}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading();}_updateQueues(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,s)=>{e.has(s)?i.set(s,r):t.push(r);})),this._loadingNodes=i;for(const{abortController:r}of t)r.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return !0})),this._totalWork=this._computeWork(),this._updateLoading();}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading();}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading();}_idleBegin(){this._setUpdateViewNeeded();}_idleEnd(){this._setUpdateViewNeeded();}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading();}}else {for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););this._processWorkQueue(e),this._idleQueue.runTask(e);}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded();})).then((()=>{this._indexPagesLoading.delete(e);}),(()=>{this._indexPagesLoading.delete(e);})),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(t$6(t))return;this._processWorkEntry(t),e.madeProgress();}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e);}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map((e=>{const t=new AbortController,i=this._memCache.pop(e.toString());return r$2(i)?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this._loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r);}for(const i of e.remove)this._removeFromRenderer(i);})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded());})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t);}async _populateClassCodeCodedDomain(e,i){const r="CLASS_CODE",s=this.layer.fieldsIndex.get(r);if(!s||s.domain)return;if(!e.includes(s.name))return;const o=await a$5(this.layer.queryCachedStatistics(r,{signal:i}));if(!1===o.ok)return;const n=o.value,a=n&&n.labels&&n.labels.labels;a&&Array.isArray(a)&&(s.domain=new u$8({name:"CLASS_CODE",codedValues:a.map((e=>new p$2({code:e.value,name:e.label})))}));}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null;}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const r=this._splitGraphicsPerNode(e),s=this.layer.attributeStorageInfo,o=t.map((e=>u(s,e))),n=async(e,t)=>{const r=this._index.getNode(t);await n$a(o,(async t=>{const i=t.useElevation?await this._loadElevationAttributeFromGeometry(r.resourceId):await this._loadAndParseAttribute(r,t);if(i)for(const r of e)if(this._isValidPointGraphic(r)){const e=r.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,i,e,r.attributes);}}));},a=[];return r.forEach(((e,t)=>{a.push(n(e,t));})),await E$4(a),e}_isValidPointGraphic(e){return e instanceof t&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i]);}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return r$2(i)?a$6({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=c$5(t,await this._loadGeometry(e,null));return d$2(i,i.length/3)}highlight(e){if(!e)return {remove(){}};const t=j$2.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue");}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new h(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded();}))}_loadNodePage(e){const t=new AbortController,i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return {promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return !1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(r/(.75*t));for(;r>t;)e*=s,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount);}return t}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,s=t.viewForward,o=P(s,t.eye),n=T(s,-o,me),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:h,maxScale:u}=r$6(this.layer),p=0===h&&0===u?e=>l.push(e):e=>{const t=this._getScale(e);c$6(t,h,u)&&l.push(e);};return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return !1;if(0===t.childCount)return p(e),!1;const r=this._index.getRenderObb(e);return !(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,n,a)<=d)||(p(e),!1)},pageMiss:(e,t)=>{p(e),this._indexQueue.includes(t)||this._indexQueue.push(t);}}),l}_getScale(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t);}return t}_computeAveragePixelArea(e,t,i,r,s){const o=1e-7,n=Math.max(o,L(e,r));return t/(n*n)/(4*s*s)/i}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(i){throw g$3(i)||ce.error(i),i}}async _loadAdditionalUserAttributes(e,t,i){const r=this.layer.outFields;if(!r)return [];const s=I$1(this.layer.fieldsIndex,r),o=new Set(e.map((e=>r$2(e)?e.name:null))),a=this.layer.attributeStorageInfo,l=[];for(const n of s){if(o.has(n))continue;const e=u(a,n);e&&l.push(t(e));}const h=await C$2(l);return f$3(i),d$3(h,(e=>e))}async _loadNodeAsync(e$1,t){const i=this._index.getNode(e$1),r=t$1(this.layer),s=e(this.layer),o=i.resourceId,d=async e=>{if(t$6(e))return null;if(e.useElevation)return {attributeInfo:e,buffer:null};const i=await this._loadAttribute(o,e,t);return r$2(i)?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push((async()=>{const i=this._loadGeometry(o,t),{primaryAttribute:n,modulationAttribute:a}=r,l=d(n),h=d(a),u=s.map((e=>e.attributeInfo)),c=u.map((e=>d(e))),_=this._loadAdditionalUserAttributes([n,a,...u],d,t),[m,g,f,y,b]=await Promise.all([i,l,h,Promise.all(c),_]);f$3(t);const w={geometryBuffer:m,primaryAttributeData:g,modulationAttributeData:f,filterAttributesData:y,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:s,obb:this._index.getRenderObb(e$1),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(w,t)}),t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(t$6(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){const i={f:"json",token:this.layer.apiKey};return this._indexRequester.request(e,"json",{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{query:{token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,ye(t));}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e));}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(e);if(X(t))return t.splatSize=r,t.obb=s,t.origin=t$8(t.obb.center),t;const o=.01*Math.max(s.halfSize[0],s.halfSize[1],s.halfSize[2]);if(t.obb.halfSize[0]>s.halfSize[0]+o||t.obb.halfSize[1]>s.halfSize[1]+o||t.obb.halfSize[2]>s.halfSize[2]+o){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;ce.warn(`Node ${e} reported bounding box too small. got ${i(s)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&ce.warn("  Too many bounding box errors, stopping reporting for this layer.");}this._index.setRenderObb(e,t.obb);}return {id:e,coordinates:t.points,origin:t$8(s.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:s,isLeaf:0===i.childCount}}getUsedMemory(){let e=0;return this._renderer.forEachNode((t=>{e+=we,e+=m$3(t.coordinates);for(const i of t.attributes){const t=i.values;o$a(t.buffer)&&(e+=m$3(t));}})),e}getUnloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*we)/t)+i*we}ignoresMemoryFactor(){return !1}get performanceInfo(){return {nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return {index:this._index,visibleNodes:this._renderedNodes}}};e$2([d$1()],ge.prototype,"layer",void 0),e$2([d$1({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],ge.prototype,"baseUrl",void 0),e$2([d$1({readOnly:!0})],ge.prototype,"pointScale",null),e$2([d$1({readOnly:!0})],ge.prototype,"useRealWorldSymbolSizes",null),e$2([d$1({readOnly:!0})],ge.prototype,"pointSize",null),e$2([d$1({readOnly:!0})],ge.prototype,"inverseDensity",null),e$2([d$1()],ge.prototype,"maximumPointCount",void 0),e$2([d$1({readOnly:!0})],ge.prototype,"availableFields",null),e$2([d$1({readOnly:!0})],ge.prototype,"_clippingBox",null),e$2([d$1({readOnly:!0})],ge.prototype,"_elevationOffset",null),e$2([d$1({type:Boolean})],ge.prototype,"slicePlaneEnabled",void 0),e$2([d$1()],ge.prototype,"updating",void 0),e$2([d$1(t$9)],ge.prototype,"updatingProgress",void 0),e$2([d$1({readOnly:!0})],ge.prototype,"updatingProgressValue",null),ge=e$2([n$3("esri.views.3d.layers.PointCloudLayerView3D")],ge);const fe=ge;function ye(e){return 5*e.coordinates.length+128}const be=u$9(),we=160;

const PointCloudLayerView3D = /*#__PURE__*/Object.freeze({
  __proto__: null,
  'default': fe
});

export { PointCloudLayerView3D as P, m$1 as m };
